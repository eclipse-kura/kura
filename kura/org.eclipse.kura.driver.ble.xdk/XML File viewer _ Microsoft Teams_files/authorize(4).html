<!DOCTYPE html>
<!-- saved from url=(0030)https://teams.microsoft.com/go -->
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>Checking your credentials...</title>

  <!-- This page is loaded from login as well as in subsequent renewal iframes -->
  <!-- TODO (rtuit) Viewport based on device detection -->
  <meta name="viewport">
  <meta name="robots" content="noindex">

  <script nonce="">
    function sendAppStateChanged(state) {
      if (window.electronSafeIpc) {
        window.electronSafeIpc.send('appStateChanged', state);
      }
    }
    sendAppStateChanged('AuthstrapInitialize');
  </script>
  <script nonce="">
    sendAppStateChanged('AuthstrapAdalScriptLoading');
    /*! adal-angular v1.0.9 2018-11-13 */
"use strict";var AuthenticationContext,Logging={level:0,log:function(){}};"undefined"!=typeof module&&module.exports&&(module.exports.inject=function(t){return new AuthenticationContext(t)}),(AuthenticationContext=function(t){if(this.REQUEST_TYPE={LOGIN:"LOGIN",RENEW_TOKEN:"RENEW_TOKEN",UNKNOWN:"UNKNOWN"},this.CONSTANTS={ACCESS_TOKEN:"access_token",EXPIRES_IN:"expires_in",ID_TOKEN:"id_token",ERROR_DESCRIPTION:"error_description",SESSION_STATE:"session_state",STORAGE:{TOKEN_KEYS:"adal.token.keys",ACCESS_TOKEN_KEY:"adal.access.token.key",EXPIRATION_KEY:"adal.expiration.key",START_PAGE:"adal.start.page",START_PAGE_PARAMS:"adal.start.page.params",STATE_LOGIN:"adal.state.login",STATE_RENEW:"adal.state.renew",STATE_RENEW_RESOURCE:"adal.state.renew.resource",NONCE_IDTOKEN:"adal.nonce.idtoken",SESSION_STATE:"adal.session.state",USERNAME:"adal.username",IDTOKEN:"adal.idtoken",ERROR:"adal.error",ERROR_DESCRIPTION:"adal.error.description",LOGIN_REQUEST:"adal.login.request",LOGIN_ERROR:"adal.login.error"},RESOURCE_DELIMETER:"|",ERR_MESSAGES:{NO_TOKEN:"User is not authorized"},LOADFRAME_TIMEOUT:"15000",LOADFRAME_PENDING:"pending",LOADFRAME_TIMEOUT_CODE:"AADSTSTimeout",LOGGING_LEVEL:{ERROR:0,WARN:1,INFO:2,VERBOSE:3},LEVEL_STRING_MAP:{0:"ERROR:",1:"WARNING:",2:"INFO:",3:"VERBOSE:"},POPUP_WIDTH:483,POPUP_HEIGHT:600},AuthenticationContext.prototype._singletonInstance)return AuthenticationContext.prototype._singletonInstance;if((AuthenticationContext.prototype._singletonInstance=this).instance="https://login.microsoftonline.com/",this.config={},this.callback=null,this.popUp=!1,this._user=null,this._activeRenewals={},this._loginInProgress=!1,this._acquireTokenInProgress=!1,this._renewStates=[],this._openedWindows=[],window.loadframeStatus={},window.callBackMappedToRenewStates={},window.callBacksMappedToRenewStates={},t.displayCall&&"function"!=typeof t.displayCall)throw new Error("displayCall is not a function");if(!t.clientId)throw new Error("clientId is required");t.correlationId||(t.correlationId=this._guid()),this.config=this._cloneConfig(t),this.config.loginResource||(this.config.loginResource=this.config.clientId),this.config.redirectUri||(this.config.redirectUri=window.location.href)}).prototype.login=function(t){t=t||"";var e=this._guid();this.config.state=e,this._idTokenNonce=this._guid(),this.verbose("Expected state: "+e+" startPage:"+window.location),this._saveItem(this.CONSTANTS.STORAGE.LOGIN_REQUEST,window.location),this._saveItem(this.CONSTANTS.STORAGE.LOGIN_ERROR,""),this._saveItem(this.CONSTANTS.STORAGE.STATE_LOGIN,e),this._saveItem(this.CONSTANTS.STORAGE.NONCE_IDTOKEN,this._idTokenNonce),this._saveItem(this.CONSTANTS.STORAGE.ERROR,""),this._saveItem(this.CONSTANTS.STORAGE.ERROR_DESCRIPTION,"");var i=this._getNavigateUrl("id_token",null)+"&nonce="+encodeURIComponent(this._idTokenNonce);i=this._getUrlWithGlobalResource(i,this.config.globalResource),this._user&&this._user.profile?this._isMsaUser(this._user.profile)||(this._isGuestUser(this._user.profile)||(i+="&login_hint="+encodeURIComponent(this._user.userName)),this._urlContainsQueryStringParameter("domain_hint",i)||(i+="&domain_hint="+encodeURIComponent(this._getDomainHint()))):this._urlContainsQueryStringParameter("domain_hint",i)||(i+="&domain_hint="+encodeURIComponent(this._getDomainHint())),this.frameCallInProgress=!1,this._loginInProgress=!0,window.electronSafeIpc&&window.electronSafeIpc.send("telemetryEvent",{name:"desktop_adal_login",resource:this.config.clientId,reason:t}),this.event("adal_login",{resource:this.config.clientId,reason:t}),this.config.displayCall?this.config.displayCall(i):this.promptUser(i)},AuthenticationContext.prototype._getUrlWithGlobalResource=function(t,e){return e?t.replace("=id_token","=token id_token")+"&resource="+e:t},AuthenticationContext.prototype.loginInProgress=function(){return this._loginInProgress},AuthenticationContext.prototype._hasResource=function(t){var e=this._getItem(this.CONSTANTS.STORAGE.TOKEN_KEYS);return e&&!this._isEmpty(e)&&-1<e.indexOf(t+this.CONSTANTS.RESOURCE_DELIMETER)},AuthenticationContext.prototype.getCachedToken=function(t){if(!this._hasResource(t))return null;var e=this._getItem(this.CONSTANTS.STORAGE.ACCESS_TOKEN_KEY+t),i=this._getItem(this.CONSTANTS.STORAGE.EXPIRATION_KEY+t),n=this.config.expireOffsetSeconds||120;if(i&&i>this._now()+n)return e;if(i&&0<i){var o=i-this._now();this.info("Token cleared from local storage for resource:"+t+" expires in:"+o),this.event("adalCacheCleared",{resource:t,expiresIn:o})}return this._saveItem(this.CONSTANTS.STORAGE.ACCESS_TOKEN_KEY+t,""),this._saveItem(this.CONSTANTS.STORAGE.EXPIRATION_KEY+t,0),null},AuthenticationContext.prototype.getCachedUser=function(){if(this._user)return this._user;var t=this._getItem(this.CONSTANTS.STORAGE.IDTOKEN);return this._user=this._createUser(t),this._user},AuthenticationContext.prototype.registerCallback=function(n,o,t){this._activeRenewals[o]=n,window.callBacksMappedToRenewStates[n]||(window.callBacksMappedToRenewStates[n]=[]);var s=this;window.callBacksMappedToRenewStates[n].push(t),window.callBackMappedToRenewStates[n]||(window.callBackMappedToRenewStates[n]=function(t,e){for(var i=0;i<window.callBacksMappedToRenewStates[n].length;++i)window.callBacksMappedToRenewStates[n][i](t,e);s._activeRenewals[o]=null,window.callBacksMappedToRenewStates[n]=null,window.callBackMappedToRenewStates[n]=null})},AuthenticationContext.prototype._renewToken=function(t,e){this.info("renewToken is called for resource:"+t);var i=this._addAdalFrame("adalRenewFrame"+t),n=this._guid()+"|"+t;this._idTokenNonce=this._guid(),this.config.state=n,this._renewStates.push(n),this.verbose("Renew token Expected state: "+n);var o=this._getNavigateUrl("token",t)+"&prompt=none";this._isMsaUser(this._user.profile)||(this._isGuestUser(this._user.profile)||(o+="&login_hint="+encodeURIComponent(this._user.userName)),this._urlContainsQueryStringParameter("domain_hint",o)||(o+="&domain_hint="+encodeURIComponent(this._getDomainHint()))),o+="&nonce="+encodeURIComponent(this._idTokenNonce),this.callback=e,this.registerCallback(n,t,e),this.idTokenNonce=null,this.verbose("Navigate to:"+o),this._saveItem(this.CONSTANTS.STORAGE.LOGIN_REQUEST,""),i.src="about:blank",this._loadFrameTimeout(o,"adalRenewFrame"+t,t,this.CONSTANTS.LOADFRAME_TIMEOUT)},AuthenticationContext.prototype._renewIdToken=function(t){this.info("renewIdToken is called");var e=this._addAdalFrame("adalIdTokenFrame"),i=this._guid()+"|"+this.config.clientId;this._idTokenNonce=this._guid(),this._saveItem(this.CONSTANTS.STORAGE.NONCE_IDTOKEN,this._idTokenNonce),this.config.state=i,this._renewStates.push(i),this.verbose("Renew Idtoken Expected state: "+i);var n=this._getNavigateUrl("id_token",null)+"&prompt=none";this._isMsaUser(this._user.profile)||(this._isGuestUser(this._user.profile)||(n+="&login_hint="+encodeURIComponent(this._user.userName)),this._urlContainsQueryStringParameter("domain_hint",n)||(n+="&domain_hint="+encodeURIComponent(this._getDomainHint()))),n+="&nonce="+encodeURIComponent(this._idTokenNonce),this.registerCallback(i,this.config.clientId,t),this.idTokenNonce=null,this.verbose("Navigate to:"+n),this._saveItem(this.CONSTANTS.STORAGE.LOGIN_REQUEST,""),e.src="about:blank",this._loadFrameTimeout(n,"adalIdTokenFrame",this.config.clientId,this.CONSTANTS.LOADFRAME_TIMEOUT)},AuthenticationContext.prototype._urlContainsQueryStringParameter=function(t,e){return new RegExp("[\\?&]"+t+"=").test(e)},AuthenticationContext.prototype._loadFrameTimeout=function(t,e,i,n){this.info("Set loading state to pending for: "+i),window.loadframeStatus[i]=this.CONSTANTS.LOADFRAME_PENDING,this.event("adalIframePending",{resource:i}),this._loadFrame(t,e);var o=n/1e3,s=i,r=this;setTimeout(function(){if(window.loadframeStatus[i]===r.CONSTANTS.LOADFRAME_PENDING){r.error("Loading frame has timed out after: "+o+" seconds for resource "+s);var t=r._activeRenewals[i];t&&window.callBackMappedToRenewStates[t]&&window.callBackMappedToRenewStates[t](r.CONSTANTS.LOADFRAME_TIMEOUT_CODE+" due to timeout",null),r.error("Removing iframe session tracking for resource:"+i),r.event("adalIframeCleared",{resource:i,reason:"timeout"}),delete window.parent.loadframeStatus[i]}},n)},AuthenticationContext.prototype._loadFrame=function(e,t){var i=this;i.info("LoadFrame: "+t);var n=t;setTimeout(function(){var t=i._addAdalFrame(n);""!==t.src&&"about:blank"!==t.src||(t.src=e,i._loadFrame(e,n))},500)},AuthenticationContext.prototype.acquireToken=function(t,e){if(this._isEmpty(t))return this.warn("resource is required"),void e("resource is required",null);var i=this.getCachedToken(t);return i?(this.info("Token is already in cache for resource:"+t),void e(null,i)):this._user?void(this._activeRenewals[t]?this.registerCallback(this._activeRenewals[t],t,e):(this.event("adalAcquireToken",{resource:t}),t===this.config.clientId?(this.info("renewing idtoken"),this._renewIdToken(e)):(this.info("renewing token "+t),this._renewToken(t,e)))):(this.warn("User login is required"),void e("User login is required",null))},AuthenticationContext.prototype.acquireTokenRedirect=function(t,e,i){if(this._isEmpty(t))return this.warn("resource is required"),void n("resource is required",null,"resource is required");var n=this.callback;if(!this._user)return this.warn("User login is required"),void n("User login is required",null,"login required");if(this._acquireTokenInProgress)return this.warn("Acquire token interactive is already in progress"),void n("Acquire token interactive is already in progress",null,"Acquire token interactive is already in progress");var o=this._guid()+"|"+t;this.config.state=o,this.verbose("Renew token Expected state: "+o);var s=this._urlRemoveQueryStringParameter(this._getNavigateUrl("token",t),"prompt");if(s+="&prompt=select_account",e&&(s+=e),i&&-1===s.indexOf("&claims"))s+="&claims="+encodeURIComponent(i);else if(i&&-1!==s.indexOf("&claims"))throw new Error("Claims cannot be passed as an extraQueryParameter");s=this._addHintParameters(s),this._acquireTokenInProgress=!0,this.info("acquireToken interactive is called for the resource "+t),this._saveItem(this.CONSTANTS.STORAGE.LOGIN_REQUEST,window.location.href),this._saveItem(this.CONSTANTS.STORAGE.STATE_RENEW,o,!0),this.promptUser(s)},AuthenticationContext.prototype.acquireTokenPopup=function(t,e,i,n){if(this._isEmpty(t))return this.warn("resource is required"),void n("resource is required",null,"resource is required");if(!this._user)return this.warn("User login is required"),void n("User login is required",null,"login required");if(this._acquireTokenInProgress)return this.warn("Acquire token interactive is already in progress"),void n("Acquire token interactive is already in progress",null,"Acquire token interactive is already in progress");var o=this._guid()+"|"+t;this.config.state=o,this._renewStates.push(o),this._requestType=this.REQUEST_TYPE.RENEW_TOKEN,this.verbose("Renew token Expected state: "+o);var s=this._urlRemoveQueryStringParameter(this._getNavigateUrl("token",t),"prompt");if(s+="&prompt=select_account",e&&(s+=e),i&&-1===s.indexOf("&claims"))s+="&claims="+encodeURIComponent(i);else if(i&&-1!==s.indexOf("&claims"))throw new Error("Claims cannot be passed as an extraQueryParameter");s=this._addHintParameters(s),this._acquireTokenInProgress=!0,this.info("acquireToken interactive is called for the resource "+t),this.registerCallback(o,t,n),this._loginPopup(s,t,n)},AuthenticationContext.prototype._loginPopup=function(t,i,e){var n=this._openPopup(t,"login",this.CONSTANTS.POPUP_WIDTH,this.CONSTANTS.POPUP_HEIGHT),o=e||this.callback;if(null!=n){if(this._openedWindows.push(n),-1!=this.config.redirectUri.indexOf("#"))var s=this.config.redirectUri.split("#")[0];else s=this.config.redirectUri;var r=this,a=window.setInterval(function(){if(!n||n.closed||void 0===n.closed){var t="Popup Window closed by UI action/ Popup Window handle destroyed due to cross zone navigation in IE/Edge";return r._handlePopupError(o,i,"Popup Window closed",t,t),void window.clearInterval(a)}try{var e=n.location;if(-1!=encodeURI(e.href).indexOf(encodeURI(s)))return r.handleWindowCallback(e.hash),window.clearInterval(a),r._loginInProgress=!1,r._acquireTokenInProgress=!1,r.info("Closing popup window"),r._openedWindows=[],void n.close()}catch(t){}},1)}else{var h="Popup Window is null. This can happen if you are using IE";this._handlePopupError(o,i,"Error opening popup",h,h)}},AuthenticationContext.prototype._openPopup=function(t,e,i,n){try{var o=window.screenLeft?window.screenLeft:window.screenX,s=window.screenTop?window.screenTop:window.screenY,r=window.innerWidth||document.documentElement.clientWidth||document.body.clientWidth,a=window.innerHeight||document.documentElement.clientHeight||document.body.clientHeight,h=r/2-i/2+o,c=a/2-n/2+s,u=window.open(t,e,"width="+i+", height="+n+", top="+c+", left="+h);return u.focus&&u.focus(),u}catch(t){return this.warn("Error opening popup, "+t.message),this._loginInProgress=!1,this._acquireTokenInProgress=!1,null}},AuthenticationContext.prototype._handlePopupError=function(t,e,i,n,o){this.warn(n),this._saveItem(this.CONSTANTS.STORAGE.ERROR,i),this._saveItem(this.CONSTANTS.STORAGE.ERROR_DESCRIPTION,n),this._saveItem(this.CONSTANTS.STORAGE.LOGIN_ERROR,o),e&&this._activeRenewals[e]&&(this._activeRenewals[e]=null),this._loginInProgress=!1,this._acquireTokenInProgress=!1,t&&t(n,null,i)},AuthenticationContext.prototype._urlRemoveQueryStringParameter=function(t,e){var i=new RegExp("(\\&"+e+"=)[^&]+");return t=t.replace(i,""),i=new RegExp("("+e+"=)[^&]+&"),t=t.replace(i,""),i=new RegExp("("+e+"=)[^&]+"),t=t.replace(i,"")},AuthenticationContext.prototype._addHintParameters=function(t){if(this._user&&this._user.profile)if(this._user.profile.sid&&-1!==t.indexOf("&prompt=none"))this._urlContainsQueryStringParameter("sid",t)||(t+="&sid="+encodeURIComponent(this._user.profile.sid));else if(this._user.profile.upn&&(this._urlContainsQueryStringParameter("login_hint",t)||(t+="&login_hint="+encodeURIComponent(this._user.profile.upn)),!this._urlContainsQueryStringParameter("domain_hint",t)&&-1<this._user.profile.upn.indexOf("@"))){var e=this._user.profile.upn.split("@");t+="&domain_hint="+encodeURIComponent(e[e.length-1])}return t},AuthenticationContext.prototype.promptUser=function(t){t?(this.info("Navigate to:"+t),window.location.replace(t)):this.error("Navigate url is empty")},AuthenticationContext.prototype.clearCache=function(){this._saveItem(this.CONSTANTS.STORAGE.ACCESS_TOKEN_KEY,""),this._saveItem(this.CONSTANTS.STORAGE.EXPIRATION_KEY,0),this._saveItem(this.CONSTANTS.STORAGE.SESSION_STATE,""),this._saveItem(this.CONSTANTS.STORAGE.STATE_LOGIN,""),this._renewStates=[],this._saveItem(this.CONSTANTS.STORAGE.START_PAGE,""),this._saveItem(this.CONSTANTS.STORAGE.START_PAGE_PARAMS,""),this._saveItem(this.CONSTANTS.STORAGE.USERNAME,""),this._saveItem(this.CONSTANTS.STORAGE.IDTOKEN,""),this._saveItem(this.CONSTANTS.STORAGE.ERROR,""),this._saveItem(this.CONSTANTS.STORAGE.ERROR_DESCRIPTION,"");var t=this._getItem(this.CONSTANTS.STORAGE.TOKEN_KEYS);if(!this._isEmpty(t)){t=t.split(this.CONSTANTS.RESOURCE_DELIMETER);for(var e=0;e<t.length;e++)this._saveItem(this.CONSTANTS.STORAGE.ACCESS_TOKEN_KEY+t[e],""),this._saveItem(this.CONSTANTS.STORAGE.EXPIRATION_KEY+t[e],0)}this._saveItem(this.CONSTANTS.STORAGE.TOKEN_KEYS,"")},AuthenticationContext.prototype.clearCacheForResource=function(t){this._saveItem(this.CONSTANTS.STORAGE.STATE_RENEW,""),this._saveItem(this.CONSTANTS.STORAGE.ERROR,""),this._saveItem(this.CONSTANTS.STORAGE.ERROR_DESCRIPTION,""),this._hasResource(t)&&(this._saveItem(this.CONSTANTS.STORAGE.ACCESS_TOKEN_KEY+t,""),this._saveItem(this.CONSTANTS.STORAGE.EXPIRATION_KEY+t,0))},AuthenticationContext.prototype.logOut=function(){this.clearCache();var t="common",e="";this._user=null,this.config.tenant&&(t=this.config.tenant),this.config.instance&&(this.instance=this.config.instance),this.config.postLogoutRedirectUri&&(e="post_logout_redirect_uri="+encodeURIComponent(this.config.postLogoutRedirectUri));var i=this.instance+t+"/oauth2/logout?"+e;this.info("Logout navigate to: "+i),this.promptUser(i)},AuthenticationContext.prototype._isEmpty=function(t){return void 0===t||!t||0===t.length},AuthenticationContext.prototype.getUser=function(t){if("function"!=typeof t)throw new Error("callback is not a function");if(this.callback=t,this._user)this.callback(null,this._user);else{var e=this._getItem(this.CONSTANTS.STORAGE.IDTOKEN);this._isEmpty(e)?(this.warn("User information is not available"),this.callback("User information is not available")):(this.info("User exists in cache: "),this._user=this._createUser(e),this.callback(null,this._user))}},AuthenticationContext.prototype._isGuestUser=function(t){return t&&t.hasOwnProperty("idp")&&t.hasOwnProperty("iss")&&t.iss!==t.idp},AuthenticationContext.prototype._isMsaUser=function(t){return t&&t.hasOwnProperty("altsecid")&&0===t.altsecid.indexOf("1:")},AuthenticationContext.prototype._getDomainHint=function(){if(this._user&&this._user.userName&&-1<this._user.userName.indexOf("@")){var t=this._user.userName.split("@");return t[t.length-1]}return""},AuthenticationContext.prototype._createUser=function(t){var e=null,i=this._extractIdToken(t);return i&&i.hasOwnProperty("aud")&&(i.aud.toLowerCase()===this.config.clientId.toLowerCase()?(e={userName:"",profile:i},i.hasOwnProperty("upn")&&!this._isGuestUser(i)?e.userName=i.upn:i.hasOwnProperty("email")&&(e.userName=i.email),i.hasOwnProperty("tid")&&(this.config.tenant=i.tid)):this.warn("IdToken has invalid aud field")),e},AuthenticationContext.prototype._getHash=function(t){return-1<t.indexOf("#/")?t=t.substring(t.indexOf("#/")+2):-1<t.indexOf("#")&&(t=t.substring(1)),t},AuthenticationContext.prototype.isCallback=function(t){t=this._getHash(t);var e=this._deserialize(t);return e.hasOwnProperty(this.CONSTANTS.ERROR_DESCRIPTION)||e.hasOwnProperty(this.CONSTANTS.ACCESS_TOKEN)||e.hasOwnProperty(this.CONSTANTS.ID_TOKEN)},AuthenticationContext.prototype.getLoginError=function(){return this._getItem(this.CONSTANTS.STORAGE.LOGIN_ERROR)},AuthenticationContext.prototype.getRequestInfo=function(t){t=this._getHash(t);var e=this._deserialize(t),i={valid:!1,parameters:{},stateMatch:!1,stateResponse:"",requestType:this.REQUEST_TYPE.UNKNOWN};if(e&&((i.parameters=e).hasOwnProperty(this.CONSTANTS.ERROR_DESCRIPTION)||e.hasOwnProperty(this.CONSTANTS.ACCESS_TOKEN)||e.hasOwnProperty(this.CONSTANTS.ID_TOKEN))){i.valid=!0;var n="";if(!e.hasOwnProperty("state"))return this.warn("No state returned"),i;if(this.verbose("State: "+e.state),n=e.state,(i.stateResponse=n)===this._getItem(this.CONSTANTS.STORAGE.STATE_LOGIN))return i.requestType=this.REQUEST_TYPE.LOGIN,i.stateMatch=!0,i;if(!i.stateMatch&&window.parent&&window.parent.AuthenticationContext())for(var o=window.parent.AuthenticationContext()._renewStates,s=0;s<o.length;s++)if(o[s]===i.stateResponse){i.requestType=this.REQUEST_TYPE.RENEW_TOKEN,i.stateMatch=!0;break}}return i},AuthenticationContext.prototype._getResourceFromState=function(t){if(t){var e=t.indexOf("|");if(-1<e&&e+1<t.length)return t.substring(e+1)}return""},AuthenticationContext.prototype._getCookie=function(t){var e=("; "+document.cookie).split("; "+t+"=");if(2==e.length)return e.pop().split(";").shift()},AuthenticationContext.prototype.saveTokenFromHash=function(t){var e=this._getResourceFromState(t.stateResponse);if(this.event("adalIframeResponded",{resource:e,arrAffinity:this._getCookie("ARRAffinity")}),this.info("State status:"+t.stateMatch+"; Request type:"+t.requestType),this._saveItem(this.CONSTANTS.STORAGE.ERROR,""),this._saveItem(this.CONSTANTS.STORAGE.ERROR_DESCRIPTION,""),t.parameters.hasOwnProperty(this.CONSTANTS.ERROR_DESCRIPTION))this.error("Error :"+t.parameters.error+"; Error description:"+t.parameters[this.CONSTANTS.ERROR_DESCRIPTION]),this._saveItem(this.CONSTANTS.STORAGE.ERROR,t.parameters.error),this._saveItem(this.CONSTANTS.STORAGE.ERROR_DESCRIPTION,t.parameters[this.CONSTANTS.ERROR_DESCRIPTION]),t.requestType===this.REQUEST_TYPE.LOGIN&&(this._loginInProgress=!1,this._saveItem(this.CONSTANTS.STORAGE.LOGIN_ERROR,t.parameters.errorDescription));else if(t.stateMatch){var i;if(this.info("State is right"),t.parameters.hasOwnProperty(this.CONSTANTS.SESSION_STATE)&&this._saveItem(this.CONSTANTS.STORAGE.SESSION_STATE,t.parameters[this.CONSTANTS.SESSION_STATE]),t.parameters.hasOwnProperty(this.CONSTANTS.ACCESS_TOKEN)){this.info("Fragment has access token"),this._hasResource(e)||(i=this._getItem(this.CONSTANTS.STORAGE.TOKEN_KEYS)||"",this._saveItem(this.CONSTANTS.STORAGE.TOKEN_KEYS,i+e+this.CONSTANTS.RESOURCE_DELIMETER)),this._saveItem(this.CONSTANTS.STORAGE.ACCESS_TOKEN_KEY+e,t.parameters[this.CONSTANTS.ACCESS_TOKEN]);var n=this._expiresIn(t.parameters[this.CONSTANTS.EXPIRES_IN]),o=n-this._now();this._saveItem(this.CONSTANTS.STORAGE.EXPIRATION_KEY+e,n),this.info("Access token successfully updated in local storage for resource:"+e+" expires in:"+o+" seconds"),this.event("adalAccessTokenUpdate",{resource:e,expiresIn:o})}if(t.parameters.hasOwnProperty(this.CONSTANTS.ID_TOKEN)&&(this.info("Fragment has id token"),this._loginInProgress=!1,this._user=this._createUser(t.parameters[this.CONSTANTS.ID_TOKEN]),this._user&&this._user.profile)){var s=this._getItem(this.CONSTANTS.STORAGE.NONCE_IDTOKEN);if(this._user.profile.nonce!==s){var r="Nonce in profile is not the same as whats in storage. profile.nonce:"+this._user.profile.nonce+", stored nonce:"+s;this._user=null,this._saveItem(this.CONSTANTS.STORAGE.LOGIN_ERROR,r)}else{this._saveItem(this.CONSTANTS.STORAGE.IDTOKEN,t.parameters[this.CONSTANTS.ID_TOKEN]),e=this.config.loginResource?this.config.loginResource:this.config.clientId,this._hasResource(e)||(i=this._getItem(this.CONSTANTS.STORAGE.TOKEN_KEYS)||"",this._saveItem(this.CONSTANTS.STORAGE.TOKEN_KEYS,i+e+this.CONSTANTS.RESOURCE_DELIMETER)),this._saveItem(this.CONSTANTS.STORAGE.ACCESS_TOKEN_KEY+e,t.parameters[this.CONSTANTS.ID_TOKEN]);var a=this._user.profile.exp||0,h=a-this._now();this._saveItem(this.CONSTANTS.STORAGE.EXPIRATION_KEY+e,a),this.info("ID token successfully updated in local storage for resource:"+e+" expires in:"+h+" seconds"),this.event("adalIdTokenUpdate",{resource:e,expiresIn:h})}}}else this._saveItem(this.CONSTANTS.STORAGE.ERROR,"Invalid_state"),this._saveItem(this.CONSTANTS.STORAGE.ERROR_DESCRIPTION,"Invalid_state. state: "+t.stateResponse);window.parent&&window.parent.loadframeStatus&&e&&(this.info("Removing iframe session tracking for resource:"+e),this.event("adalIframeCleared",{resource:e,reason:"saved token from hash"}),delete window.parent.loadframeStatus[e])},AuthenticationContext.prototype.getResourceForEndpoint=function(t){if(this.config&&this.config.endpoints)for(var e in this.config.endpoints)if(-1<t.indexOf(e))return this.config.endpoints[e];return-1<t.indexOf("http://")||-1<t.indexOf("https://")?this._getHostFromUri(t)===this._getHostFromUri(this.config.redirectUri)?this.config.loginResource:null:this.config.loginResource},AuthenticationContext.prototype._getHostFromUri=function(t){var e=String(t).replace(/^(https?:)\/\//,"");return e=e.split("/")[0]},AuthenticationContext.prototype.handleWindowCallback=function(t){if(null==t&&(t=window.location.hash),this.isCallback(t)){var e=this.getRequestInfo(t);this.info("Returned from redirect url"),this.saveTokenFromHash(e);var i=null;if(e.requestType===this.REQUEST_TYPE.RENEW_TOKEN&&window.parent?(this.info("Window is in iframe"),i=window.parent.callBackMappedToRenewStates[e.stateResponse],this.verbose("iframe came back, deleting iframe session tracking for "+e.stateResponse),window.src=""):window&&window.oauth2Callback&&(this.verbose("Window is redirecting"),i=this.callback),window.location.hash="",window.location=this._getItem(this.CONSTANTS.STORAGE.LOGIN_REQUEST),i&&e.requestType===this.REQUEST_TYPE.RENEW_TOKEN)return this.info("Executing window callback"),void i(this._getItem(this.CONSTANTS.STORAGE.ERROR_DESCRIPTION),e.parameters[this.CONSTANTS.ACCESS_TOKEN]||e.parameters[this.CONSTANTS.ID_TOKEN])}},AuthenticationContext.prototype._getNavigateUrl=function(t,e){var i="common";this.config.tenant&&(i=this.config.tenant),this.config.instance&&(this.instance=this.config.instance);var n=this.instance+i+"/oauth2/authorize"+this._serialize(t,this.config,e)+this._addLibMetadata();return this.info("Navigate url:"+n),n},AuthenticationContext.prototype._extractIdToken=function(t){var e=this._decodeJwt(t);if(!e)return null;try{var i=e.JWSPayload,n=this._base64DecodeStringUrlSafe(i);return n?JSON.parse(n):(this.info("The returned id_token could not be base64 url safe decoded."),null)}catch(t){this.error("The returned id_token could not be decoded",t)}return null},AuthenticationContext.prototype._extractUserName=function(t){try{var e=this._extractIdToken(t);if(e){if(e.hasOwnProperty("upn"))return e.upn;if(e.hasOwnProperty("email"))return e.email}}catch(t){this.error("The returned id_token could not be decoded",t)}return null},AuthenticationContext.prototype._base64DecodeStringUrlSafe=function(t){return t=t.replace(/-/g,"+").replace(/_/g,"/"),window.atob?decodeURIComponent(escape(window.atob(t))):decodeURIComponent(escape(this._decode(t)))},AuthenticationContext.prototype._decode=function(t){var e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",i=(t=String(t).replace(/=+$/,"")).length;if(i%4==1)throw new Error("The token to be decoded is not correctly encoded.");for(var n,o,s,r,a,h,c,u,l="",d=0;d<i;d+=4){if(n=e.indexOf(t.charAt(d)),o=e.indexOf(t.charAt(d+1)),s=e.indexOf(t.charAt(d+2)),r=e.indexOf(t.charAt(d+3)),d+2===i-1){h=(a=n<<18|o<<12|s<<6)>>16&255,c=a>>8&255,l+=String.fromCharCode(h,c);break}if(d+1===i-1){h=(a=n<<18|o<<12)>>16&255,l+=String.fromCharCode(h);break}h=(a=n<<18|o<<12|s<<6|r)>>16&255,c=a>>8&255,u=255&a,l+=String.fromCharCode(h,c,u)}return l},AuthenticationContext.prototype._decodeJwt=function(t){if(this._isEmpty(t))return null;var e=/^([^\.\s]*)\.([^\.\s]+)\.([^\.\s]*)$/.exec(t);return!e||e.length<4?(this.warn("The returned id_token is not parseable."),null):{header:e[1],JWSPayload:e[2],JWSSig:e[3]}},AuthenticationContext.prototype._convertUrlSafeToRegularBase64EncodedString=function(t){return t.replace("-","+").replace("_","/")},AuthenticationContext.prototype._serialize=function(t,e,i){var n=[];return null!==e&&(n.push("?response_type="+t),n.push("client_id="+encodeURIComponent(e.clientId)),i&&n.push("resource="+encodeURIComponent(i)),n.push("redirect_uri="+encodeURIComponent(e.redirectUri)),n.push("state="+encodeURIComponent(e.state)),e.hasOwnProperty("slice")&&n.push("slice="+encodeURIComponent(e.slice)),e.hasOwnProperty("extraQueryParameter")&&n.push(e.extraQueryParameter),e.correlationId&&n.push("client-request-id="+encodeURIComponent(e.correlationId))),n.join("&")},AuthenticationContext.prototype._deserialize=function(t){var e,i=/\+/g,n=/([^&=]+)=?([^&]*)/g,o=function(t){return decodeURIComponent(t.replace(i," "))},s={};for(e=n.exec(t);e;)s[o(e[1])]=o(e[2]),e=n.exec(t);return s},AuthenticationContext.prototype._guid=function(){for(var t="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx",e="0123456789abcdef",i=0,n="",o=0;o<36;o++)"-"!==t[o]&&"4"!==t[o]&&(i=16*Math.random()|0),"x"===t[o]?n+=e[i]:"y"===t[o]?(i&=3,n+=e[i|=8]):n+=t[o];return n},AuthenticationContext.prototype._expiresIn=function(t){return this._now()+parseInt(t,10)},AuthenticationContext.prototype._now=function(){return Math.round((new Date).getTime()/1e3)},AuthenticationContext.prototype._addAdalFrame=function(t){if(void 0!==t){var e=document.getElementById(t);if(!e){if(this.info("Attempting to add adal frame to document:"+t),document.createElement&&document.documentElement&&(window.opera||-1===window.navigator.userAgent.indexOf("MSIE 5.0"))){var i=document.createElement("iframe");i.setAttribute("id",t),i.style.visibility="hidden",i.style.position="absolute",i.style.width=i.style.height=i.borderWidth="0px",e=document.getElementsByTagName("body")[0].appendChild(i)}else document.body&&document.body.insertAdjacentHTML&&document.body.insertAdjacentHTML("beforeEnd",'<iframe name="'+t+'" id="'+t+'" style="display:none"></iframe>');window.frames&&window.frames[t]&&(e=window.frames[t]),e&&(this.info("Added adal frame to document:"+t),this.event("adalAddIframe",{resource:t}))}return e}},AuthenticationContext.prototype._saveItem=function(t,e){return this.config&&this.config.cacheLocation&&"localStorage"===this.config.cacheLocation?this._supportsLocalStorage()?(localStorage.setItem(t,e),!0):(this.info("Local storage is not supported"),!1):this._supportsSessionStorage()?(sessionStorage.setItem(t,e),!0):(this.info("Session storage is not supported"),!1)},AuthenticationContext.prototype._getItem=function(t){return this.config&&this.config.cacheLocation&&"localStorage"===this.config.cacheLocation?this._supportsLocalStorage()?localStorage.getItem(t):(this.info("Local storage is not supported"),null):this._supportsSessionStorage()?sessionStorage.getItem(t):(this.info("Session storage is not supported"),null)},AuthenticationContext.prototype._supportsLocalStorage=function(){try{return"localStorage"in window&&window.localStorage}catch(t){return!1}},AuthenticationContext.prototype._supportsSessionStorage=function(){try{return"sessionStorage"in window&&window.sessionStorage}catch(t){return!1}},AuthenticationContext.prototype._cloneConfig=function(t){if(null===t||"object"!=typeof t)return t;var e={};for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i]);return e},AuthenticationContext.prototype._addLibMetadata=function(){return"&x-client-SKU=Js&x-client-Ver="+this._libVersion()},AuthenticationContext.prototype.log=function(t,e,i){if(t<=Logging.level){var n=this.config.correlationId,o=(new Date).toUTCString()+":"+n+"-"+this._libVersion()+"-"+this.CONSTANTS.LEVEL_STRING_MAP[t]+" "+e;i&&(o+="\nstack:\n"+i.stack),Logging.log(o)}},AuthenticationContext.prototype.tryLogtoTopFrame=function(t,e,i){if(window.self!==window.top){var n=window.top?window.top.AuthenticationLogger:void 0,o="Iframe - AuthenticationContext: {0}, {1}";i&&(o+=", {2}"),n&&n[t]&&n[t].call(n,o,this.config.correlationId,e,i)}},AuthenticationContext.prototype.trySendEventToTopFrame=function(t,e){if(window.self!==window.top){var i=window.top?window.top.AuthenticationLogEventCallback:void 0;i&&i(t,e)}},AuthenticationContext.prototype.error=function(t,e){this.log(this.CONSTANTS.LOGGING_LEVEL.ERROR,t,e),this.tryLogtoTopFrame("error",t,e)},AuthenticationContext.prototype.warn=function(t){this.log(this.CONSTANTS.LOGGING_LEVEL.WARN,t,null),this.tryLogtoTopFrame("warn",t)},AuthenticationContext.prototype.info=function(t){this.log(this.CONSTANTS.LOGGING_LEVEL.INFO,t,null),this.tryLogtoTopFrame("info",t)},AuthenticationContext.prototype.verbose=function(t){this.log(this.CONSTANTS.LOGGING_LEVEL.VERBOSE,t,null),this.tryLogtoTopFrame("verbose",t)},AuthenticationContext.prototype.event=function(t,e){this.trySendEventToTopFrame(t,e)},AuthenticationContext.prototype._libVersion=function(){return"1.0.9"};
    sendAppStateChanged('AuthstrapAdalScriptLoaded');
  </script>
  <script nonce="">
    (function () {
      document.addEventListener("DOMContentLoaded", function () {
        sendAppStateChanged('AuthstrapDomContentLoaded');

        /** WARNINGS
         * 1 - IF YOU UPDATE THIS FILE you need to keep in mind that this file is currently served from local disc
         * which is different from all other resources. Therefore be sure your change is backwards compat with the FE bits.
         *
         * 2 - Authstrap is only loaded for the adal authentication as
         * the framework requires this. Therefore the client id is hard coded
         * to the adal client id.
         */

        var teamspace;
(function (teamspace) {
    var auth;
    (function (auth) {
        /**
         * WARNING: If you update this file you need to keep in mind that this file is compiled and inserting into Authstrap.html.
         * Currently this file is served from local disc which is different from all other resources. Therefore be sure your change
         * is backwards compat with the FE bits.
         */
        var AuthStrapBase = /** @class */ (function () {
            function AuthStrapBase(authContext, redirectUrl, $window, feCookieName, localStorage, sessionStorage, console, document, lastLocationHashName, showError, secureCookie, enableCookieStore, signInStateCookieName) {
                this.authContext = authContext;
                this.redirectUrl = redirectUrl;
                this.$window = $window;
                this.feCookieName = feCookieName;
                this.localStorage = localStorage;
                this.sessionStorage = sessionStorage;
                this.console = console;
                this.document = document;
                this.lastLocationHashName = lastLocationHashName;
                this.showError = showError;
                this.secureCookie = secureCookie;
                this.enableCookieStore = enableCookieStore;
                this.signInStateCookieName = signInStateCookieName;
            }
            AuthStrapBase.prototype.isInIFrame = function () {
                try {
                    return this.$window.self !== this.$window.top;
                }
                catch (e) {
                    this.showError(e);
                    return true;
                }
            };
            AuthStrapBase.prototype.updateFECookie = function (value) {
                value = value || '';
                if (this.enableCookieStore) {
                    var expireDate = new Date(Date.now() + 5 * 24 * 60 * 60 * 1000); // 5 Days
                    this.document.cookie = this.feCookieName + "=" + value + "; expires=" + expireDate + "; path=/" + (this.secureCookie ? '; secure' : '');
                }
                else {
                    this.document.cookie = this.feCookieName + "=" + value + "; path=/" + (this.secureCookie ? '; secure' : '');
                }
            };
            /**
             * Updates the preauth signin cookie if the user is logged in
             * @param value
             */
            AuthStrapBase.prototype.updatePreSignInCookie = function (value) {
                value = value || '';
                var expireDate = new Date(Date.now() + 365 * 24 * 60 * 60 * 1000); // 1 year
                this.document.cookie = this.signInStateCookieName + "=" + value + "; expires=" + expireDate + "; path=/" + (this.secureCookie ? '; secure' : '');
            };
            AuthStrapBase.prototype.sendTelemetry = function (area) {
                var url = this.redirectUrl + "auth/" + area;
                var httpRequest = new XMLHttpRequest();
                httpRequest.open("GET", url, true);
                httpRequest.send(null);
            };
            AuthStrapBase.prototype.handleRedirect = function (user) {
                this.tryWarnLog('Redirecting to index');
                if (user) {
                    // Update the fe auth cookie with the current client ID token in
                    // case this is a valid user and that is missing the token.
                    this.updateFECookie(this.authContext.getCachedToken(user.profile.aud));
                    this.updatePreSignInCookie("true");
                }
                var newLocation = this.redirectUrl;
                var endsWith = function (str, c) { return str.length > 0 && str.charAt(str.length - 1) === c; };
                if (!endsWith(newLocation, '/')) {
                    newLocation += '/';
                }
                // Takes the user to the index page
                newLocation += '_';
                if (AuthStrapBase.shouldIgnoreHashForRedirect(this.document.location.hash) &&
                    this.document.location.search === '') {
                    // Get stored location for the previous url from before the user logged in
                    var previousUrl = this.getLocationForNonLoggedInUser();
                    if (previousUrl) {
                        newLocation += previousUrl;
                        if (this.localStorage) {
                            this.localStorage.removeItem(AuthStrapBase.nonLoggedInUserLocationKey);
                        }
                        if (this.sessionStorage) {
                            this.sessionStorage.removeItem(AuthStrapBase.nonLoggedInUserLocationKey);
                        }
                    }
                    else {
                        // if there was no specified url, then replace it with the user's previous url from localStorage if it is available
                        if (user) {
                            newLocation += this.getLocationForLoggedInUser(user.profile);
                        }
                    }
                }
                else {
                    newLocation += this.document.location.search + this.document.location.hash;
                }
                if (this.sessionStorage) {
                    this.sessionStorage.setItem(AuthStrapBase.redirect_authstrap_duration, performance.now());
                }
                this.document.location.replace(newLocation);
            };
            /**
             * Gets the url from session storage for a previously anonymous user who is now logged in.
             * This is used for the redirection after coming back from login
             */
            AuthStrapBase.prototype.getLocationForNonLoggedInUser = function () {
                var url = '';
                // On Edge and IE we're coming back with id_token in the hash instead of an empty hash.
                // The below conditional corrects for that; otherwise try to load from storage
                if (this.document.location.hash &&
                    (this.document.location.hash.indexOf(AuthStrapBase.idTokenString) >= 0)) {
                    url = this.document.location.hash;
                }
                else if (this.localStorage) {
                    url = this.localStorage.getItem(AuthStrapBase.nonLoggedInUserLocationKey);
                }
                else if (this.sessionStorage) {
                    url = this.sessionStorage.getItem(AuthStrapBase.nonLoggedInUserLocationKey);
                }
                return url;
            };
            /**
             * Gets the url hash from local storage stored for the user in previous sessions
             */
            AuthStrapBase.prototype.getLocationForLoggedInUser = function (profile) {
                var url = '';
                var startHash = this.document.location.hash;
                if (!startHash && this.localStorage && profile && profile.oid) {
                    // 'ts.' is auto prefixed to the local storage keys in the normal app workflow here. Oid is used as the partition.
                    startHash = this.localStorage.getItem('ts.' + profile.oid + '.' + this.lastLocationHashName); // with oid
                }
                if (startHash) {
                    url += '#' + startHash.replace(/^#|#$/, '');
                }
                return url;
            };
            AuthStrapBase.prototype.tryWarnLog = function (text) {
                if (this.console) {
                    console.warn(text);
                }
            };
            /**
             * Check to make sure that the hash is empty or contains a token that indicates
             * we should use this hash for redirect. Returns true if the hash is empty or
             * contains the token.
             */
            AuthStrapBase.shouldIgnoreHashForRedirect = function (hash) {
                return (hash && (hash.indexOf(AuthStrapBase.idTokenString) >= 0)) ||
                    (hash === '') || (hash === '#');
            };
            AuthStrapBase.nonLoggedInUserLocationKey = "ts.nonLoggedInUserLocation";
            AuthStrapBase.redirect_authstrap_duration = "ts.redirect_authstrap_duration";
            AuthStrapBase.idTokenString = 'id_token=';
            return AuthStrapBase;
        }());
        auth.AuthStrapBase = AuthStrapBase;
    })(auth = teamspace.auth || (teamspace.auth = {}));
})(teamspace || (teamspace = {}));

//# sourceMappingURL=data:application/json;base64,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QVMsVUFBVSxPQUFPO0dBQy9DLGNBQWMsWUFBWTsyQ0FDYyIsInNvdXJjZXNDb250ZW50IjpbInZhciB0ZWFtc3BhY2U7XHJcbihmdW5jdGlvbiAodGVhbXNwYWNlKSB7XHJcbiAgICB2YXIgYXV0aDtcclxuICAgIChmdW5jdGlvbiAoYXV0aCkge1xyXG4gICAgICAgIC8qKlxyXG4gICAgICAgICAqIFdBUk5JTkc6IElmIHlvdSB1cGRhdGUgdGhpcyBmaWxlIHlvdSBuZWVkIHRvIGtlZXAgaW4gbWluZCB0aGF0IHRoaXMgZmlsZSBpcyBjb21waWxlZCBhbmQgaW5zZXJ0aW5nIGludG8gQXV0aHN0cmFwLmh0bWwuXHJcbiAgICAgICAgICogQ3VycmVudGx5IHRoaXMgZmlsZSBpcyBzZXJ2ZWQgZnJvbSBsb2NhbCBkaXNjIHdoaWNoIGlzIGRpZmZlcmVudCBmcm9tIGFsbCBvdGhlciByZXNvdXJjZXMuIFRoZXJlZm9yZSBiZSBzdXJlIHlvdXIgY2hhbmdlXHJcbiAgICAgICAgICogaXMgYmFja3dhcmRzIGNvbXBhdCB3aXRoIHRoZSBGRSBiaXRzLlxyXG4gICAgICAgICAqL1xyXG4gICAgICAgIHZhciBBdXRoU3RyYXBCYXNlID0gLyoqIEBjbGFzcyAqLyAoZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICBmdW5jdGlvbiBBdXRoU3RyYXBCYXNlKGF1dGhDb250ZXh0LCByZWRpcmVjdFVybCwgJHdpbmRvdywgZmVDb29raWVOYW1lLCBsb2NhbFN0b3JhZ2UsIHNlc3Npb25TdG9yYWdlLCBjb25zb2xlLCBkb2N1bWVudCwgbGFzdExvY2F0aW9uSGFzaE5hbWUsIHNob3dFcnJvciwgc2VjdXJlQ29va2llLCBlbmFibGVDb29raWVTdG9yZSwgc2lnbkluU3RhdGVDb29raWVOYW1lKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmF1dGhDb250ZXh0ID0gYXV0aENvbnRleHQ7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnJlZGlyZWN0VXJsID0gcmVkaXJlY3RVcmw7XHJcbiAgICAgICAgICAgICAgICB0aGlzLiR3aW5kb3cgPSAkd2luZG93O1xyXG4gICAgICAgICAgICAgICAgdGhpcy5mZUNvb2tpZU5hbWUgPSBmZUNvb2tpZU5hbWU7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmxvY2FsU3RvcmFnZSA9IGxvY2FsU3RvcmFnZTtcclxuICAgICAgICAgICAgICAgIHRoaXMuc2Vzc2lvblN0b3JhZ2UgPSBzZXNzaW9uU3RvcmFnZTtcclxuICAgICAgICAgICAgICAgIHRoaXMuY29uc29sZSA9IGNvbnNvbGU7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmRvY3VtZW50ID0gZG9jdW1lbnQ7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmxhc3RMb2NhdGlvbkhhc2hOYW1lID0gbGFzdExvY2F0aW9uSGFzaE5hbWU7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnNob3dFcnJvciA9IHNob3dFcnJvcjtcclxuICAgICAgICAgICAgICAgIHRoaXMuc2VjdXJlQ29va2llID0gc2VjdXJlQ29va2llO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5lbmFibGVDb29raWVTdG9yZSA9IGVuYWJsZUNvb2tpZVN0b3JlO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5zaWduSW5TdGF0ZUNvb2tpZU5hbWUgPSBzaWduSW5TdGF0ZUNvb2tpZU5hbWU7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgQXV0aFN0cmFwQmFzZS5wcm90b3R5cGUuaXNJbklGcmFtZSA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuJHdpbmRvdy5zZWxmICE9PSB0aGlzLiR3aW5kb3cudG9wO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgY2F0Y2ggKGUpIHtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLnNob3dFcnJvcihlKTtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgQXV0aFN0cmFwQmFzZS5wcm90b3R5cGUudXBkYXRlRkVDb29raWUgPSBmdW5jdGlvbiAodmFsdWUpIHtcclxuICAgICAgICAgICAgICAgIHZhbHVlID0gdmFsdWUgfHwgJyc7XHJcbiAgICAgICAgICAgICAgICBpZiAodGhpcy5lbmFibGVDb29raWVTdG9yZSkge1xyXG4gICAgICAgICAgICAgICAgICAgIHZhciBleHBpcmVEYXRlID0gbmV3IERhdGUoRGF0ZS5ub3coKSArIDUgKiAyNCAqIDYwICogNjAgKiAxMDAwKTsgLy8gNSBEYXlzXHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5kb2N1bWVudC5jb29raWUgPSB0aGlzLmZlQ29va2llTmFtZSArIFwiPVwiICsgdmFsdWUgKyBcIjsgZXhwaXJlcz1cIiArIGV4cGlyZURhdGUgKyBcIjsgcGF0aD0vXCIgKyAodGhpcy5zZWN1cmVDb29raWUgPyAnOyBzZWN1cmUnIDogJycpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5kb2N1bWVudC5jb29raWUgPSB0aGlzLmZlQ29va2llTmFtZSArIFwiPVwiICsgdmFsdWUgKyBcIjsgcGF0aD0vXCIgKyAodGhpcy5zZWN1cmVDb29raWUgPyAnOyBzZWN1cmUnIDogJycpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICAvKipcclxuICAgICAgICAgICAgICogVXBkYXRlcyB0aGUgcHJlYXV0aCBzaWduaW4gY29va2llIGlmIHRoZSB1c2VyIGlzIGxvZ2dlZCBpblxyXG4gICAgICAgICAgICAgKiBAcGFyYW0gdmFsdWVcclxuICAgICAgICAgICAgICovXHJcbiAgICAgICAgICAgIEF1dGhTdHJhcEJhc2UucHJvdG90eXBlLnVwZGF0ZVByZVNpZ25JbkNvb2tpZSA9IGZ1bmN0aW9uICh2YWx1ZSkge1xyXG4gICAgICAgICAgICAgICAgdmFsdWUgPSB2YWx1ZSB8fCAnJztcclxuICAgICAgICAgICAgICAgIHZhciBleHBpcmVEYXRlID0gbmV3IERhdGUoRGF0ZS5ub3coKSArIDM2NSAqIDI0ICogNjAgKiA2MCAqIDEwMDApOyAvLyAxIHllYXJcclxuICAgICAgICAgICAgICAgIHRoaXMuZG9jdW1lbnQuY29va2llID0gdGhpcy5zaWduSW5TdGF0ZUNvb2tpZU5hbWUgKyBcIj1cIiArIHZhbHVlICsgXCI7IGV4cGlyZXM9XCIgKyBleHBpcmVEYXRlICsgXCI7IHBhdGg9L1wiICsgKHRoaXMuc2VjdXJlQ29va2llID8gJzsgc2VjdXJlJyA6ICcnKTtcclxuICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgQXV0aFN0cmFwQmFzZS5wcm90b3R5cGUuc2VuZFRlbGVtZXRyeSA9IGZ1bmN0aW9uIChhcmVhKSB7XHJcbiAgICAgICAgICAgICAgICB2YXIgdXJsID0gdGhpcy5yZWRpcmVjdFVybCArIFwiYXV0aC9cIiArIGFyZWE7XHJcbiAgICAgICAgICAgICAgICB2YXIgaHR0cFJlcXVlc3QgPSBuZXcgWE1MSHR0cFJlcXVlc3QoKTtcclxuICAgICAgICAgICAgICAgIGh0dHBSZXF1ZXN0Lm9wZW4oXCJHRVRcIiwgdXJsLCB0cnVlKTtcclxuICAgICAgICAgICAgICAgIGh0dHBSZXF1ZXN0LnNlbmQobnVsbCk7XHJcbiAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgIEF1dGhTdHJhcEJhc2UucHJvdG90eXBlLmhhbmRsZVJlZGlyZWN0ID0gZnVuY3Rpb24gKHVzZXIpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMudHJ5V2FybkxvZygnUmVkaXJlY3RpbmcgdG8gaW5kZXgnKTtcclxuICAgICAgICAgICAgICAgIGlmICh1c2VyKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgLy8gVXBkYXRlIHRoZSBmZSBhdXRoIGNvb2tpZSB3aXRoIHRoZSBjdXJyZW50IGNsaWVudCBJRCB0b2tlbiBpblxyXG4gICAgICAgICAgICAgICAgICAgIC8vIGNhc2UgdGhpcyBpcyBhIHZhbGlkIHVzZXIgYW5kIHRoYXQgaXMgbWlzc2luZyB0aGUgdG9rZW4uXHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy51cGRhdGVGRUNvb2tpZSh0aGlzLmF1dGhDb250ZXh0LmdldENhY2hlZFRva2VuKHVzZXIucHJvZmlsZS5hdWQpKTtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLnVwZGF0ZVByZVNpZ25JbkNvb2tpZShcInRydWVcIik7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB2YXIgbmV3TG9jYXRpb24gPSB0aGlzLnJlZGlyZWN0VXJsO1xyXG4gICAgICAgICAgICAgICAgdmFyIGVuZHNXaXRoID0gZnVuY3Rpb24gKHN0ciwgYykgeyByZXR1cm4gc3RyLmxlbmd0aCA+IDAgJiYgc3RyLmNoYXJBdChzdHIubGVuZ3RoIC0gMSkgPT09IGM7IH07XHJcbiAgICAgICAgICAgICAgICBpZiAoIWVuZHNXaXRoKG5ld0xvY2F0aW9uLCAnLycpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgbmV3TG9jYXRpb24gKz0gJy8nO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgLy8gVGFrZXMgdGhlIHVzZXIgdG8gdGhlIGluZGV4IHBhZ2VcclxuICAgICAgICAgICAgICAgIG5ld0xvY2F0aW9uICs9ICdfJztcclxuICAgICAgICAgICAgICAgIGlmIChBdXRoU3RyYXBCYXNlLnNob3VsZElnbm9yZUhhc2hGb3JSZWRpcmVjdCh0aGlzLmRvY3VtZW50LmxvY2F0aW9uLmhhc2gpICYmXHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5kb2N1bWVudC5sb2NhdGlvbi5zZWFyY2ggPT09ICcnKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgLy8gR2V0IHN0b3JlZCBsb2NhdGlvbiBmb3IgdGhlIHByZXZpb3VzIHVybCBmcm9tIGJlZm9yZSB0aGUgdXNlciBsb2dnZWQgaW5cclxuICAgICAgICAgICAgICAgICAgICB2YXIgcHJldmlvdXNVcmwgPSB0aGlzLmdldExvY2F0aW9uRm9yTm9uTG9nZ2VkSW5Vc2VyKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKHByZXZpb3VzVXJsKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIG5ld0xvY2F0aW9uICs9IHByZXZpb3VzVXJsO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5sb2NhbFN0b3JhZ2UpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubG9jYWxTdG9yYWdlLnJlbW92ZUl0ZW0oQXV0aFN0cmFwQmFzZS5ub25Mb2dnZWRJblVzZXJMb2NhdGlvbktleSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuc2Vzc2lvblN0b3JhZ2UpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc2Vzc2lvblN0b3JhZ2UucmVtb3ZlSXRlbShBdXRoU3RyYXBCYXNlLm5vbkxvZ2dlZEluVXNlckxvY2F0aW9uS2V5KTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgLy8gaWYgdGhlcmUgd2FzIG5vIHNwZWNpZmllZCB1cmwsIHRoZW4gcmVwbGFjZSBpdCB3aXRoIHRoZSB1c2VyJ3MgcHJldmlvdXMgdXJsIGZyb20gbG9jYWxTdG9yYWdlIGlmIGl0IGlzIGF2YWlsYWJsZVxyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAodXNlcikge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbmV3TG9jYXRpb24gKz0gdGhpcy5nZXRMb2NhdGlvbkZvckxvZ2dlZEluVXNlcih1c2VyLnByb2ZpbGUpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgbmV3TG9jYXRpb24gKz0gdGhpcy5kb2N1bWVudC5sb2NhdGlvbi5zZWFyY2ggKyB0aGlzLmRvY3VtZW50LmxvY2F0aW9uLmhhc2g7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBpZiAodGhpcy5zZXNzaW9uU3RvcmFnZSkge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuc2Vzc2lvblN0b3JhZ2Uuc2V0SXRlbShBdXRoU3RyYXBCYXNlLnJlZGlyZWN0X2F1dGhzdHJhcF9kdXJhdGlvbiwgcGVyZm9ybWFuY2Uubm93KCkpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgdGhpcy5kb2N1bWVudC5sb2NhdGlvbi5yZXBsYWNlKG5ld0xvY2F0aW9uKTtcclxuICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgLyoqXHJcbiAgICAgICAgICAgICAqIEdldHMgdGhlIHVybCBmcm9tIHNlc3Npb24gc3RvcmFnZSBmb3IgYSBwcmV2aW91c2x5IGFub255bW91cyB1c2VyIHdobyBpcyBub3cgbG9nZ2VkIGluLlxyXG4gICAgICAgICAgICAgKiBUaGlzIGlzIHVzZWQgZm9yIHRoZSByZWRpcmVjdGlvbiBhZnRlciBjb21pbmcgYmFjayBmcm9tIGxvZ2luXHJcbiAgICAgICAgICAgICAqL1xyXG4gICAgICAgICAgICBBdXRoU3RyYXBCYXNlLnByb3RvdHlwZS5nZXRMb2NhdGlvbkZvck5vbkxvZ2dlZEluVXNlciA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgICAgIHZhciB1cmwgPSAnJztcclxuICAgICAgICAgICAgICAgIC8vIE9uIEVkZ2UgYW5kIElFIHdlJ3JlIGNvbWluZyBiYWNrIHdpdGggaWRfdG9rZW4gaW4gdGhlIGhhc2ggaW5zdGVhZCBvZiBhbiBlbXB0eSBoYXNoLlxyXG4gICAgICAgICAgICAgICAgLy8gVGhlIGJlbG93IGNvbmRpdGlvbmFsIGNvcnJlY3RzIGZvciB0aGF0OyBvdGhlcndpc2UgdHJ5IHRvIGxvYWQgZnJvbSBzdG9yYWdlXHJcbiAgICAgICAgICAgICAgICBpZiAodGhpcy5kb2N1bWVudC5sb2NhdGlvbi5oYXNoICYmXHJcbiAgICAgICAgICAgICAgICAgICAgKHRoaXMuZG9jdW1lbnQubG9jYXRpb24uaGFzaC5pbmRleE9mKEF1dGhTdHJhcEJhc2UuaWRUb2tlblN0cmluZykgPj0gMCkpIHtcclxuICAgICAgICAgICAgICAgICAgICB1cmwgPSB0aGlzLmRvY3VtZW50LmxvY2F0aW9uLmhhc2g7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBlbHNlIGlmICh0aGlzLmxvY2FsU3RvcmFnZSkge1xyXG4gICAgICAgICAgICAgICAgICAgIHVybCA9IHRoaXMubG9jYWxTdG9yYWdlLmdldEl0ZW0oQXV0aFN0cmFwQmFzZS5ub25Mb2dnZWRJblVzZXJMb2NhdGlvbktleSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBlbHNlIGlmICh0aGlzLnNlc3Npb25TdG9yYWdlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdXJsID0gdGhpcy5zZXNzaW9uU3RvcmFnZS5nZXRJdGVtKEF1dGhTdHJhcEJhc2Uubm9uTG9nZ2VkSW5Vc2VyTG9jYXRpb25LZXkpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHVybDtcclxuICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgLyoqXHJcbiAgICAgICAgICAgICAqIEdldHMgdGhlIHVybCBoYXNoIGZyb20gbG9jYWwgc3RvcmFnZSBzdG9yZWQgZm9yIHRoZSB1c2VyIGluIHByZXZpb3VzIHNlc3Npb25zXHJcbiAgICAgICAgICAgICAqL1xyXG4gICAgICAgICAgICBBdXRoU3RyYXBCYXNlLnByb3RvdHlwZS5nZXRMb2NhdGlvbkZvckxvZ2dlZEluVXNlciA9IGZ1bmN0aW9uIChwcm9maWxlKSB7XHJcbiAgICAgICAgICAgICAgICB2YXIgdXJsID0gJyc7XHJcbiAgICAgICAgICAgICAgICB2YXIgc3RhcnRIYXNoID0gdGhpcy5kb2N1bWVudC5sb2NhdGlvbi5oYXNoO1xyXG4gICAgICAgICAgICAgICAgaWYgKCFzdGFydEhhc2ggJiYgdGhpcy5sb2NhbFN0b3JhZ2UgJiYgcHJvZmlsZSAmJiBwcm9maWxlLm9pZCkge1xyXG4gICAgICAgICAgICAgICAgICAgIC8vICd0cy4nIGlzIGF1dG8gcHJlZml4ZWQgdG8gdGhlIGxvY2FsIHN0b3JhZ2Uga2V5cyBpbiB0aGUgbm9ybWFsIGFwcCB3b3JrZmxvdyBoZXJlLiBPaWQgaXMgdXNlZCBhcyB0aGUgcGFydGl0aW9uLlxyXG4gICAgICAgICAgICAgICAgICAgIHN0YXJ0SGFzaCA9IHRoaXMubG9jYWxTdG9yYWdlLmdldEl0ZW0oJ3RzLicgKyBwcm9maWxlLm9pZCArICcuJyArIHRoaXMubGFzdExvY2F0aW9uSGFzaE5hbWUpOyAvLyB3aXRoIG9pZFxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgaWYgKHN0YXJ0SGFzaCkge1xyXG4gICAgICAgICAgICAgICAgICAgIHVybCArPSAnIycgKyBzdGFydEhhc2gucmVwbGFjZSgvXiN8IyQvLCAnJyk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gdXJsO1xyXG4gICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICBBdXRoU3RyYXBCYXNlLnByb3RvdHlwZS50cnlXYXJuTG9nID0gZnVuY3Rpb24gKHRleHQpIHtcclxuICAgICAgICAgICAgICAgIGlmICh0aGlzLmNvbnNvbGUpIHtcclxuICAgICAgICAgICAgICAgICAgICBjb25zb2xlLndhcm4odGV4dCk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgIC8qKlxyXG4gICAgICAgICAgICAgKiBDaGVjayB0byBtYWtlIHN1cmUgdGhhdCB0aGUgaGFzaCBpcyBlbXB0eSBvciBjb250YWlucyBhIHRva2VuIHRoYXQgaW5kaWNhdGVzXHJcbiAgICAgICAgICAgICAqIHdlIHNob3VsZCB1c2UgdGhpcyBoYXNoIGZvciByZWRpcmVjdC4gUmV0dXJucyB0cnVlIGlmIHRoZSBoYXNoIGlzIGVtcHR5IG9yXHJcbiAgICAgICAgICAgICAqIGNvbnRhaW5zIHRoZSB0b2tlbi5cclxuICAgICAgICAgICAgICovXHJcbiAgICAgICAgICAgIEF1dGhTdHJhcEJhc2Uuc2hvdWxkSWdub3JlSGFzaEZvclJlZGlyZWN0ID0gZnVuY3Rpb24gKGhhc2gpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiAoaGFzaCAmJiAoaGFzaC5pbmRleE9mKEF1dGhTdHJhcEJhc2UuaWRUb2tlblN0cmluZykgPj0gMCkpIHx8XHJcbiAgICAgICAgICAgICAgICAgICAgKGhhc2ggPT09ICcnKSB8fCAoaGFzaCA9PT0gJyMnKTtcclxuICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgQXV0aFN0cmFwQmFzZS5ub25Mb2dnZWRJblVzZXJMb2NhdGlvbktleSA9IFwidHMubm9uTG9nZ2VkSW5Vc2VyTG9jYXRpb25cIjtcclxuICAgICAgICAgICAgQXV0aFN0cmFwQmFzZS5yZWRpcmVjdF9hdXRoc3RyYXBfZHVyYXRpb24gPSBcInRzLnJlZGlyZWN0X2F1dGhzdHJhcF9kdXJhdGlvblwiO1xyXG4gICAgICAgICAgICBBdXRoU3RyYXBCYXNlLmlkVG9rZW5TdHJpbmcgPSAnaWRfdG9rZW49JztcclxuICAgICAgICAgICAgcmV0dXJuIEF1dGhTdHJhcEJhc2U7XHJcbiAgICAgICAgfSgpKTtcclxuICAgICAgICBhdXRoLkF1dGhTdHJhcEJhc2UgPSBBdXRoU3RyYXBCYXNlO1xyXG4gICAgfSkoYXV0aCA9IHRlYW1zcGFjZS5hdXRoIHx8ICh0ZWFtc3BhY2UuYXV0aCA9IHt9KSk7XHJcbn0pKHRlYW1zcGFjZSB8fCAodGVhbXNwYWNlID0ge30pKTtcclxuIl19
        var __extends = (this && this.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p]; };
        return extendStatics(d, b);
    }
    return function (d, b) {
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();
var teamspace;
(function (teamspace) {
    var auth;
    (function (auth) {
        /**
         * WARNING: If you update this file you need to keep in mind that this file is compiled and inserting into Authstrap.html.
         * Currently this file is served from local disc which is different from all other resources. Therefore be sure your change
         * is backwards compat with the FE bits.
         */
        var AuthStrap = /** @class */ (function (_super) {
            __extends(AuthStrap, _super);
            function AuthStrap(authContext, redirectUrl, $window, feCookieName, localStorage, sessionStorage, console, document, lastLocationHashName, redirectRoute, showError, secureCookie, enableCookieStore, signInStateCookieName, enableGuestAccess) {
                var _this = _super.call(this, authContext, redirectUrl, $window, feCookieName, localStorage, sessionStorage, console, document, lastLocationHashName, showError, secureCookie, enableCookieStore, signInStateCookieName) || this;
                _this.redirectRoute = redirectRoute;
                _this.enableGuestAccess = enableGuestAccess;
                if (_this.authContext.getLoginError() && _this.console) {
                    _this.console.error('Authorization error: ' + _this.authContext.getLoginError());
                }
                return _this;
            }
            /**
             * Stores the url in session storage for anonymous users prior to login
             * This is used for the redirection after coming back from login
             */
            AuthStrap.prototype.storeLocationForNonLoggedInUser = function () {
                var href = window.location.href.replace(this.redirectUrl, '');
                // Remove the leading '/' if it is there in the previous url
                // Example:
                // original url: http://dev.local/#/calendar?meetingId=AA
                // href: /#/calendar?meetingId=AA
                // href after substr call : #/calendar?meetingId=AA
                if (href.indexOf('/') === 0) {
                    href = href.substr(1);
                }
                // disallow 'go' urls from being saved
                if (href && this.localStorage && (href.indexOf(this.redirectRoute) !== 0)) {
                    this.localStorage.setItem(auth.AuthStrapBase.nonLoggedInUserLocationKey, href);
                }
            };
            /**
             * Checks to see if the users profile is a invalid.
             */
            AuthStrap.prototype.shouldLogoutInvalidProfile = function (user) {
                if (!user.profile.aud) {
                    this.tryWarnLog('User profile type is missing aud');
                    return true;
                }
                else if (!user.profile.oid && user.profile.altsecid && user.profile.altsecid.indexOf('1:') === 0) {
                    // Check if user is an MSA user by seeing if altsecid starts with "1:"
                    // user is an MSA account. do not log out.
                    user.profile.oid = 'msaDefaultOid';
                    return false;
                }
                else {
                    var isGuest = user.profile.iss &&
                        user.profile.idp &&
                        user.profile.iss !== user.profile.idp;
                    // Unredeemed guests will not have an oid
                    // authenticationService will kick out the user if there's no oid, so set one now
                    if (isGuest && !user.profile.oid) {
                        user.profile.oid = 'aadDefaultOid';
                        return false;
                    }
                    // Non guest access requires upn
                    if (!isGuest && (!user.profile.oid || !user.profile.upn)) {
                        this.tryWarnLog('User profile is missing oid or upn');
                        return true;
                    }
                }
                return false;
            };
            AuthStrap.prototype.profileExpiresIn = function (user, minutes) {
                var profileExpiration = (user && user.profile &&
                    (user.profile.exp ? parseInt(user.profile.exp, 10) * 1000 : Date.now()));
                return (profileExpiration - Date.now()) <= (1000 * 60 * minutes);
            };
            /**
             * Checks to see if the user profile exists or expires within the next 2 minutes.
             * If there is not user token or profile within then the user should be logged in.
             */
            AuthStrap.prototype.shouldLogInInvalidProfile = function (user, tenant) {
                // Do not let through without a valid profile or exp date it puts the app in a bad state.
                var invalidUserState = !user || !user.profile || !this.authContext.getCachedToken(user.profile.aud);
                if (invalidUserState) {
                    if (tenant) {
                        this.authContext.config.tenant = tenant;
                    }
                    this.tryWarnLog('User profile not found');
                }
                else if (tenant && user.profile.tid != tenant && this.enableGuestAccess) {
                    this.sendTelemetry("changeTenant?tid=" + user.profile.tid + "&newTid=" + tenant);
                    this.tryWarnLog('User is logged into a different tenant');
                    // overwrite the tenant stored in config becuase it could have gotten populated by the tenant from existing token
                    this.authContext.config.tenant = tenant;
                    this.authContext.clearCache();
                    invalidUserState = true;
                }
                else {
                    invalidUserState = this.profileExpiresIn(user, 2);
                    if (invalidUserState) {
                        this.tryWarnLog('User profile expired');
                    }
                }
                return invalidUserState;
            };
            /**
             * Updates the user state by logging them in or out according to flag provided.
             * @param logUserIn
             */
            AuthStrap.prototype.transferUser = function (logUserIn) {
                this.updateFECookie(null);
                this.sendTelemetry("prelogin");
                if (logUserIn) {
                    this.tryWarnLog('Logging user in');
                    if (window.electronSafeIpc) {
                        window.electronSafeIpc.send('telemetryEvent', {
                            name: 'desktop_adal_login',
                            reason: 'authstrap'
                        });
                    }
                    this.authContext.login();
                }
                else {
                    this.tryWarnLog('Logging user out');
                    if (window.electronSafeIpc) {
                        window.electronSafeIpc.send('telemetryEvent', {
                            name: 'desktop_adal_logout',
                            reason: 'authstrap'
                        });
                    }
                    this.authContext.logOut();
                }
            };
            /**
             * Applies the domain hint to the auth context if present in
             * the query params.
             */
            AuthStrap.prototype.setDomainHintIfPresentAsQSP = function () {
                if (this.document.location.href && this.authContext.config) {
                    var domainHint = this.getQueryParameterByName('domain_hint', this.document.location.href);
                    if (domainHint) {
                        if (this.authContext.config.extraQueryParameter && this.authContext.config.extraQueryParameter.length > 0) {
                            this.authContext.config.extraQueryParameter += '&domain_hint=' + domainHint;
                        }
                        else {
                            this.authContext.config.extraQueryParameter = 'domain_hint=' + domainHint;
                        }
                    }
                }
            };
            /**
             * Handles the login flow with adal both user redirect as well as iframe refresh.
             *
             * If not an iframe the user is logging in initially or by return to the site.
             *    If the user is not logged in(or profile expired), login via adal is executed which redirects to the site once complete.
             *    Else redirects to the site.
             * If in an iframe this is a token refresh, tell adal the window is loaded via callback. That is all that is needed. **DO NOT REDIRECT TO SITE**
             */
            AuthStrap.prototype.handleWindow = function () {
                // Check for AAD error in URL
                if (window.location.hash.indexOf("AADSTS50000") >= 0) {
                    window.location.assign(this.redirectUrl + 'error/incompatible_compliance_policy');
                    return;
                }
                this.authContext.handleWindowCallback();
                this.setDomainHintIfPresentAsQSP();
                // If the context is an iframe our job is done once we execute the callback handler as our source is loaded. This
                // will relay the token back to the caller.
                if (this.isInIFrame()) {
                    return;
                }
                try {
                    var user = this.authContext.getCachedUser();
                    // get tenant from query string parameter and pass it in below
                    var tenant = this.getTenantId(window.location.href);
                    if (this.shouldLogInInvalidProfile(user, tenant)) {
                        // save the url for reload once the user is logged in
                        this.storeLocationForNonLoggedInUser();
                        this.transferUser(true);
                    }
                    else if (this.shouldLogoutInvalidProfile(user)) {
                        this.transferUser(false);
                    }
                    else {
                        this.sendTelemetry("postlogin");
                        this.handleRedirect(user);
                    }
                }
                catch (e) {
                    this.showError(e);
                }
            };
            AuthStrap.prototype.getQueryParameterByName = function (name, url) {
                if (!url) {
                    url = window.location.href;
                }
                name = name.replace(/[\[\]]/g, "\\$&");
                var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"), results = regex.exec(url);
                if (!results) {
                    return null;
                }
                if (!results[2]) {
                    return '';
                }
                return decodeURIComponent(results[2].replace(/\+/g, " "));
            };
            AuthStrap.prototype.getTenantId = function (url) {
                if (url) {
                    return this.getQueryParameterByName('tenantId', url);
                }
                return undefined;
            };
            return AuthStrap;
        }(auth.AuthStrapBase));
        auth.AuthStrap = AuthStrap;
    })(auth = teamspace.auth || (teamspace.auth = {}));
})(teamspace || (teamspace = {}));

//# sourceMappingURL=data:application/json;base64,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SztnQkFDN0MsSUFBSSxLQUFLO29CQUNMLE9BQU8sS0FBSyx3QkFBd0IsWUFBWTs7Z0JBRXBELE9BQU87O1lBRVgsT0FBTztVQUNULEtBQUs7UUFDUCxLQUFLLFlBQVk7T0FDbEIsT0FBTyxVQUFVLFNBQVMsVUFBVSxPQUFPO0dBQy9DLGNBQWMsWUFBWTtzQ0FDUyIsInNvdXJjZXNDb250ZW50IjpbInZhciBfX2V4dGVuZHMgPSAodGhpcyAmJiB0aGlzLl9fZXh0ZW5kcykgfHwgKGZ1bmN0aW9uICgpIHtcclxuICAgIHZhciBleHRlbmRTdGF0aWNzID0gZnVuY3Rpb24gKGQsIGIpIHtcclxuICAgICAgICBleHRlbmRTdGF0aWNzID0gT2JqZWN0LnNldFByb3RvdHlwZU9mIHx8XHJcbiAgICAgICAgICAgICh7IF9fcHJvdG9fXzogW10gfSBpbnN0YW5jZW9mIEFycmF5ICYmIGZ1bmN0aW9uIChkLCBiKSB7IGQuX19wcm90b19fID0gYjsgfSkgfHxcclxuICAgICAgICAgICAgZnVuY3Rpb24gKGQsIGIpIHsgZm9yICh2YXIgcCBpbiBiKSBpZiAoYi5oYXNPd25Qcm9wZXJ0eShwKSkgZFtwXSA9IGJbcF07IH07XHJcbiAgICAgICAgcmV0dXJuIGV4dGVuZFN0YXRpY3MoZCwgYik7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gZnVuY3Rpb24gKGQsIGIpIHtcclxuICAgICAgICBleHRlbmRTdGF0aWNzKGQsIGIpO1xyXG4gICAgICAgIGZ1bmN0aW9uIF9fKCkgeyB0aGlzLmNvbnN0cnVjdG9yID0gZDsgfVxyXG4gICAgICAgIGQucHJvdG90eXBlID0gYiA9PT0gbnVsbCA/IE9iamVjdC5jcmVhdGUoYikgOiAoX18ucHJvdG90eXBlID0gYi5wcm90b3R5cGUsIG5ldyBfXygpKTtcclxuICAgIH07XHJcbn0pKCk7XHJcbnZhciB0ZWFtc3BhY2U7XHJcbihmdW5jdGlvbiAodGVhbXNwYWNlKSB7XHJcbiAgICB2YXIgYXV0aDtcclxuICAgIChmdW5jdGlvbiAoYXV0aCkge1xyXG4gICAgICAgIC8qKlxyXG4gICAgICAgICAqIFdBUk5JTkc6IElmIHlvdSB1cGRhdGUgdGhpcyBmaWxlIHlvdSBuZWVkIHRvIGtlZXAgaW4gbWluZCB0aGF0IHRoaXMgZmlsZSBpcyBjb21waWxlZCBhbmQgaW5zZXJ0aW5nIGludG8gQXV0aHN0cmFwLmh0bWwuXHJcbiAgICAgICAgICogQ3VycmVudGx5IHRoaXMgZmlsZSBpcyBzZXJ2ZWQgZnJvbSBsb2NhbCBkaXNjIHdoaWNoIGlzIGRpZmZlcmVudCBmcm9tIGFsbCBvdGhlciByZXNvdXJjZXMuIFRoZXJlZm9yZSBiZSBzdXJlIHlvdXIgY2hhbmdlXHJcbiAgICAgICAgICogaXMgYmFja3dhcmRzIGNvbXBhdCB3aXRoIHRoZSBGRSBiaXRzLlxyXG4gICAgICAgICAqL1xyXG4gICAgICAgIHZhciBBdXRoU3RyYXAgPSAvKiogQGNsYXNzICovIChmdW5jdGlvbiAoX3N1cGVyKSB7XHJcbiAgICAgICAgICAgIF9fZXh0ZW5kcyhBdXRoU3RyYXAsIF9zdXBlcik7XHJcbiAgICAgICAgICAgIGZ1bmN0aW9uIEF1dGhTdHJhcChhdXRoQ29udGV4dCwgcmVkaXJlY3RVcmwsICR3aW5kb3csIGZlQ29va2llTmFtZSwgbG9jYWxTdG9yYWdlLCBzZXNzaW9uU3RvcmFnZSwgY29uc29sZSwgZG9jdW1lbnQsIGxhc3RMb2NhdGlvbkhhc2hOYW1lLCByZWRpcmVjdFJvdXRlLCBzaG93RXJyb3IsIHNlY3VyZUNvb2tpZSwgZW5hYmxlQ29va2llU3RvcmUsIHNpZ25JblN0YXRlQ29va2llTmFtZSwgZW5hYmxlR3Vlc3RBY2Nlc3MpIHtcclxuICAgICAgICAgICAgICAgIHZhciBfdGhpcyA9IF9zdXBlci5jYWxsKHRoaXMsIGF1dGhDb250ZXh0LCByZWRpcmVjdFVybCwgJHdpbmRvdywgZmVDb29raWVOYW1lLCBsb2NhbFN0b3JhZ2UsIHNlc3Npb25TdG9yYWdlLCBjb25zb2xlLCBkb2N1bWVudCwgbGFzdExvY2F0aW9uSGFzaE5hbWUsIHNob3dFcnJvciwgc2VjdXJlQ29va2llLCBlbmFibGVDb29raWVTdG9yZSwgc2lnbkluU3RhdGVDb29raWVOYW1lKSB8fCB0aGlzO1xyXG4gICAgICAgICAgICAgICAgX3RoaXMucmVkaXJlY3RSb3V0ZSA9IHJlZGlyZWN0Um91dGU7XHJcbiAgICAgICAgICAgICAgICBfdGhpcy5lbmFibGVHdWVzdEFjY2VzcyA9IGVuYWJsZUd1ZXN0QWNjZXNzO1xyXG4gICAgICAgICAgICAgICAgaWYgKF90aGlzLmF1dGhDb250ZXh0LmdldExvZ2luRXJyb3IoKSAmJiBfdGhpcy5jb25zb2xlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgX3RoaXMuY29uc29sZS5lcnJvcignQXV0aG9yaXphdGlvbiBlcnJvcjogJyArIF90aGlzLmF1dGhDb250ZXh0LmdldExvZ2luRXJyb3IoKSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gX3RoaXM7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgLyoqXHJcbiAgICAgICAgICAgICAqIFN0b3JlcyB0aGUgdXJsIGluIHNlc3Npb24gc3RvcmFnZSBmb3IgYW5vbnltb3VzIHVzZXJzIHByaW9yIHRvIGxvZ2luXHJcbiAgICAgICAgICAgICAqIFRoaXMgaXMgdXNlZCBmb3IgdGhlIHJlZGlyZWN0aW9uIGFmdGVyIGNvbWluZyBiYWNrIGZyb20gbG9naW5cclxuICAgICAgICAgICAgICovXHJcbiAgICAgICAgICAgIEF1dGhTdHJhcC5wcm90b3R5cGUuc3RvcmVMb2NhdGlvbkZvck5vbkxvZ2dlZEluVXNlciA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgICAgIHZhciBocmVmID0gd2luZG93LmxvY2F0aW9uLmhyZWYucmVwbGFjZSh0aGlzLnJlZGlyZWN0VXJsLCAnJyk7XHJcbiAgICAgICAgICAgICAgICAvLyBSZW1vdmUgdGhlIGxlYWRpbmcgJy8nIGlmIGl0IGlzIHRoZXJlIGluIHRoZSBwcmV2aW91cyB1cmxcclxuICAgICAgICAgICAgICAgIC8vIEV4YW1wbGU6XHJcbiAgICAgICAgICAgICAgICAvLyBvcmlnaW5hbCB1cmw6IGh0dHA6Ly9kZXYubG9jYWwvIy9jYWxlbmRhcj9tZWV0aW5nSWQ9QUFcclxuICAgICAgICAgICAgICAgIC8vIGhyZWY6IC8jL2NhbGVuZGFyP21lZXRpbmdJZD1BQVxyXG4gICAgICAgICAgICAgICAgLy8gaHJlZiBhZnRlciBzdWJzdHIgY2FsbCA6ICMvY2FsZW5kYXI/bWVldGluZ0lkPUFBXHJcbiAgICAgICAgICAgICAgICBpZiAoaHJlZi5pbmRleE9mKCcvJykgPT09IDApIHtcclxuICAgICAgICAgICAgICAgICAgICBocmVmID0gaHJlZi5zdWJzdHIoMSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAvLyBkaXNhbGxvdyAnZ28nIHVybHMgZnJvbSBiZWluZyBzYXZlZFxyXG4gICAgICAgICAgICAgICAgaWYgKGhyZWYgJiYgdGhpcy5sb2NhbFN0b3JhZ2UgJiYgKGhyZWYuaW5kZXhPZih0aGlzLnJlZGlyZWN0Um91dGUpICE9PSAwKSkge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMubG9jYWxTdG9yYWdlLnNldEl0ZW0oYXV0aC5BdXRoU3RyYXBCYXNlLm5vbkxvZ2dlZEluVXNlckxvY2F0aW9uS2V5LCBocmVmKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgLyoqXHJcbiAgICAgICAgICAgICAqIENoZWNrcyB0byBzZWUgaWYgdGhlIHVzZXJzIHByb2ZpbGUgaXMgYSBpbnZhbGlkLlxyXG4gICAgICAgICAgICAgKi9cclxuICAgICAgICAgICAgQXV0aFN0cmFwLnByb3RvdHlwZS5zaG91bGRMb2dvdXRJbnZhbGlkUHJvZmlsZSA9IGZ1bmN0aW9uICh1c2VyKSB7XHJcbiAgICAgICAgICAgICAgICBpZiAoIXVzZXIucHJvZmlsZS5hdWQpIHtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLnRyeVdhcm5Mb2coJ1VzZXIgcHJvZmlsZSB0eXBlIGlzIG1pc3NpbmcgYXVkJyk7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBlbHNlIGlmICghdXNlci5wcm9maWxlLm9pZCAmJiB1c2VyLnByb2ZpbGUuYWx0c2VjaWQgJiYgdXNlci5wcm9maWxlLmFsdHNlY2lkLmluZGV4T2YoJzE6JykgPT09IDApIHtcclxuICAgICAgICAgICAgICAgICAgICAvLyBDaGVjayBpZiB1c2VyIGlzIGFuIE1TQSB1c2VyIGJ5IHNlZWluZyBpZiBhbHRzZWNpZCBzdGFydHMgd2l0aCBcIjE6XCJcclxuICAgICAgICAgICAgICAgICAgICAvLyB1c2VyIGlzIGFuIE1TQSBhY2NvdW50LiBkbyBub3QgbG9nIG91dC5cclxuICAgICAgICAgICAgICAgICAgICB1c2VyLnByb2ZpbGUub2lkID0gJ21zYURlZmF1bHRPaWQnO1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIHZhciBpc0d1ZXN0ID0gdXNlci5wcm9maWxlLmlzcyAmJlxyXG4gICAgICAgICAgICAgICAgICAgICAgICB1c2VyLnByb2ZpbGUuaWRwICYmXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHVzZXIucHJvZmlsZS5pc3MgIT09IHVzZXIucHJvZmlsZS5pZHA7XHJcbiAgICAgICAgICAgICAgICAgICAgLy8gVW5yZWRlZW1lZCBndWVzdHMgd2lsbCBub3QgaGF2ZSBhbiBvaWRcclxuICAgICAgICAgICAgICAgICAgICAvLyBhdXRoZW50aWNhdGlvblNlcnZpY2Ugd2lsbCBraWNrIG91dCB0aGUgdXNlciBpZiB0aGVyZSdzIG5vIG9pZCwgc28gc2V0IG9uZSBub3dcclxuICAgICAgICAgICAgICAgICAgICBpZiAoaXNHdWVzdCAmJiAhdXNlci5wcm9maWxlLm9pZCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB1c2VyLnByb2ZpbGUub2lkID0gJ2FhZERlZmF1bHRPaWQnO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIC8vIE5vbiBndWVzdCBhY2Nlc3MgcmVxdWlyZXMgdXBuXHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKCFpc0d1ZXN0ICYmICghdXNlci5wcm9maWxlLm9pZCB8fCAhdXNlci5wcm9maWxlLnVwbikpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy50cnlXYXJuTG9nKCdVc2VyIHByb2ZpbGUgaXMgbWlzc2luZyBvaWQgb3IgdXBuJyk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgQXV0aFN0cmFwLnByb3RvdHlwZS5wcm9maWxlRXhwaXJlc0luID0gZnVuY3Rpb24gKHVzZXIsIG1pbnV0ZXMpIHtcclxuICAgICAgICAgICAgICAgIHZhciBwcm9maWxlRXhwaXJhdGlvbiA9ICh1c2VyICYmIHVzZXIucHJvZmlsZSAmJlxyXG4gICAgICAgICAgICAgICAgICAgICh1c2VyLnByb2ZpbGUuZXhwID8gcGFyc2VJbnQodXNlci5wcm9maWxlLmV4cCwgMTApICogMTAwMCA6IERhdGUubm93KCkpKTtcclxuICAgICAgICAgICAgICAgIHJldHVybiAocHJvZmlsZUV4cGlyYXRpb24gLSBEYXRlLm5vdygpKSA8PSAoMTAwMCAqIDYwICogbWludXRlcyk7XHJcbiAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgIC8qKlxyXG4gICAgICAgICAgICAgKiBDaGVja3MgdG8gc2VlIGlmIHRoZSB1c2VyIHByb2ZpbGUgZXhpc3RzIG9yIGV4cGlyZXMgd2l0aGluIHRoZSBuZXh0IDIgbWludXRlcy5cclxuICAgICAgICAgICAgICogSWYgdGhlcmUgaXMgbm90IHVzZXIgdG9rZW4gb3IgcHJvZmlsZSB3aXRoaW4gdGhlbiB0aGUgdXNlciBzaG91bGQgYmUgbG9nZ2VkIGluLlxyXG4gICAgICAgICAgICAgKi9cclxuICAgICAgICAgICAgQXV0aFN0cmFwLnByb3RvdHlwZS5zaG91bGRMb2dJbkludmFsaWRQcm9maWxlID0gZnVuY3Rpb24gKHVzZXIsIHRlbmFudCkge1xyXG4gICAgICAgICAgICAgICAgLy8gRG8gbm90IGxldCB0aHJvdWdoIHdpdGhvdXQgYSB2YWxpZCBwcm9maWxlIG9yIGV4cCBkYXRlIGl0IHB1dHMgdGhlIGFwcCBpbiBhIGJhZCBzdGF0ZS5cclxuICAgICAgICAgICAgICAgIHZhciBpbnZhbGlkVXNlclN0YXRlID0gIXVzZXIgfHwgIXVzZXIucHJvZmlsZSB8fCAhdGhpcy5hdXRoQ29udGV4dC5nZXRDYWNoZWRUb2tlbih1c2VyLnByb2ZpbGUuYXVkKTtcclxuICAgICAgICAgICAgICAgIGlmIChpbnZhbGlkVXNlclN0YXRlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKHRlbmFudCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmF1dGhDb250ZXh0LmNvbmZpZy50ZW5hbnQgPSB0ZW5hbnQ7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMudHJ5V2FybkxvZygnVXNlciBwcm9maWxlIG5vdCBmb3VuZCcpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgZWxzZSBpZiAodGVuYW50ICYmIHVzZXIucHJvZmlsZS50aWQgIT0gdGVuYW50ICYmIHRoaXMuZW5hYmxlR3Vlc3RBY2Nlc3MpIHtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLnNlbmRUZWxlbWV0cnkoXCJjaGFuZ2VUZW5hbnQ/dGlkPVwiICsgdXNlci5wcm9maWxlLnRpZCArIFwiJm5ld1RpZD1cIiArIHRlbmFudCk7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy50cnlXYXJuTG9nKCdVc2VyIGlzIGxvZ2dlZCBpbnRvIGEgZGlmZmVyZW50IHRlbmFudCcpO1xyXG4gICAgICAgICAgICAgICAgICAgIC8vIG92ZXJ3cml0ZSB0aGUgdGVuYW50IHN0b3JlZCBpbiBjb25maWcgYmVjdWFzZSBpdCBjb3VsZCBoYXZlIGdvdHRlbiBwb3B1bGF0ZWQgYnkgdGhlIHRlbmFudCBmcm9tIGV4aXN0aW5nIHRva2VuXHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5hdXRoQ29udGV4dC5jb25maWcudGVuYW50ID0gdGVuYW50O1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuYXV0aENvbnRleHQuY2xlYXJDYWNoZSgpO1xyXG4gICAgICAgICAgICAgICAgICAgIGludmFsaWRVc2VyU3RhdGUgPSB0cnVlO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgaW52YWxpZFVzZXJTdGF0ZSA9IHRoaXMucHJvZmlsZUV4cGlyZXNJbih1c2VyLCAyKTtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoaW52YWxpZFVzZXJTdGF0ZSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnRyeVdhcm5Mb2coJ1VzZXIgcHJvZmlsZSBleHBpcmVkJyk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGludmFsaWRVc2VyU3RhdGU7XHJcbiAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgIC8qKlxyXG4gICAgICAgICAgICAgKiBVcGRhdGVzIHRoZSB1c2VyIHN0YXRlIGJ5IGxvZ2dpbmcgdGhlbSBpbiBvciBvdXQgYWNjb3JkaW5nIHRvIGZsYWcgcHJvdmlkZWQuXHJcbiAgICAgICAgICAgICAqIEBwYXJhbSBsb2dVc2VySW5cclxuICAgICAgICAgICAgICovXHJcbiAgICAgICAgICAgIEF1dGhTdHJhcC5wcm90b3R5cGUudHJhbnNmZXJVc2VyID0gZnVuY3Rpb24gKGxvZ1VzZXJJbikge1xyXG4gICAgICAgICAgICAgICAgdGhpcy51cGRhdGVGRUNvb2tpZShudWxsKTtcclxuICAgICAgICAgICAgICAgIHRoaXMuc2VuZFRlbGVtZXRyeShcInByZWxvZ2luXCIpO1xyXG4gICAgICAgICAgICAgICAgaWYgKGxvZ1VzZXJJbikge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMudHJ5V2FybkxvZygnTG9nZ2luZyB1c2VyIGluJyk7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5lbGVjdHJvblNhZmVJcGMpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmVsZWN0cm9uU2FmZUlwYy5zZW5kKCd0ZWxlbWV0cnlFdmVudCcsIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5hbWU6ICdkZXNrdG9wX2FkYWxfbG9naW4nLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVhc29uOiAnYXV0aHN0cmFwJ1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5hdXRoQ29udGV4dC5sb2dpbigpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy50cnlXYXJuTG9nKCdMb2dnaW5nIHVzZXIgb3V0Jyk7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5lbGVjdHJvblNhZmVJcGMpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmVsZWN0cm9uU2FmZUlwYy5zZW5kKCd0ZWxlbWV0cnlFdmVudCcsIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5hbWU6ICdkZXNrdG9wX2FkYWxfbG9nb3V0JyxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlYXNvbjogJ2F1dGhzdHJhcCdcclxuICAgICAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuYXV0aENvbnRleHQubG9nT3V0KCk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgIC8qKlxyXG4gICAgICAgICAgICAgKiBBcHBsaWVzIHRoZSBkb21haW4gaGludCB0byB0aGUgYXV0aCBjb250ZXh0IGlmIHByZXNlbnQgaW5cclxuICAgICAgICAgICAgICogdGhlIHF1ZXJ5IHBhcmFtcy5cclxuICAgICAgICAgICAgICovXHJcbiAgICAgICAgICAgIEF1dGhTdHJhcC5wcm90b3R5cGUuc2V0RG9tYWluSGludElmUHJlc2VudEFzUVNQID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICAgICAgaWYgKHRoaXMuZG9jdW1lbnQubG9jYXRpb24uaHJlZiAmJiB0aGlzLmF1dGhDb250ZXh0LmNvbmZpZykge1xyXG4gICAgICAgICAgICAgICAgICAgIHZhciBkb21haW5IaW50ID0gdGhpcy5nZXRRdWVyeVBhcmFtZXRlckJ5TmFtZSgnZG9tYWluX2hpbnQnLCB0aGlzLmRvY3VtZW50LmxvY2F0aW9uLmhyZWYpO1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChkb21haW5IaW50KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmF1dGhDb250ZXh0LmNvbmZpZy5leHRyYVF1ZXJ5UGFyYW1ldGVyICYmIHRoaXMuYXV0aENvbnRleHQuY29uZmlnLmV4dHJhUXVlcnlQYXJhbWV0ZXIubGVuZ3RoID4gMCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5hdXRoQ29udGV4dC5jb25maWcuZXh0cmFRdWVyeVBhcmFtZXRlciArPSAnJmRvbWFpbl9oaW50PScgKyBkb21haW5IaW50O1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5hdXRoQ29udGV4dC5jb25maWcuZXh0cmFRdWVyeVBhcmFtZXRlciA9ICdkb21haW5faGludD0nICsgZG9tYWluSGludDtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgLyoqXHJcbiAgICAgICAgICAgICAqIEhhbmRsZXMgdGhlIGxvZ2luIGZsb3cgd2l0aCBhZGFsIGJvdGggdXNlciByZWRpcmVjdCBhcyB3ZWxsIGFzIGlmcmFtZSByZWZyZXNoLlxyXG4gICAgICAgICAgICAgKlxyXG4gICAgICAgICAgICAgKiBJZiBub3QgYW4gaWZyYW1lIHRoZSB1c2VyIGlzIGxvZ2dpbmcgaW4gaW5pdGlhbGx5IG9yIGJ5IHJldHVybiB0byB0aGUgc2l0ZS5cclxuICAgICAgICAgICAgICogICAgSWYgdGhlIHVzZXIgaXMgbm90IGxvZ2dlZCBpbihvciBwcm9maWxlIGV4cGlyZWQpLCBsb2dpbiB2aWEgYWRhbCBpcyBleGVjdXRlZCB3aGljaCByZWRpcmVjdHMgdG8gdGhlIHNpdGUgb25jZSBjb21wbGV0ZS5cclxuICAgICAgICAgICAgICogICAgRWxzZSByZWRpcmVjdHMgdG8gdGhlIHNpdGUuXHJcbiAgICAgICAgICAgICAqIElmIGluIGFuIGlmcmFtZSB0aGlzIGlzIGEgdG9rZW4gcmVmcmVzaCwgdGVsbCBhZGFsIHRoZSB3aW5kb3cgaXMgbG9hZGVkIHZpYSBjYWxsYmFjay4gVGhhdCBpcyBhbGwgdGhhdCBpcyBuZWVkZWQuICoqRE8gTk9UIFJFRElSRUNUIFRPIFNJVEUqKlxyXG4gICAgICAgICAgICAgKi9cclxuICAgICAgICAgICAgQXV0aFN0cmFwLnByb3RvdHlwZS5oYW5kbGVXaW5kb3cgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgICAgICAvLyBDaGVjayBmb3IgQUFEIGVycm9yIGluIFVSTFxyXG4gICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5sb2NhdGlvbi5oYXNoLmluZGV4T2YoXCJBQURTVFM1MDAwMFwiKSA+PSAwKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgd2luZG93LmxvY2F0aW9uLmFzc2lnbih0aGlzLnJlZGlyZWN0VXJsICsgJ2Vycm9yL2luY29tcGF0aWJsZV9jb21wbGlhbmNlX3BvbGljeScpO1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIHRoaXMuYXV0aENvbnRleHQuaGFuZGxlV2luZG93Q2FsbGJhY2soKTtcclxuICAgICAgICAgICAgICAgIHRoaXMuc2V0RG9tYWluSGludElmUHJlc2VudEFzUVNQKCk7XHJcbiAgICAgICAgICAgICAgICAvLyBJZiB0aGUgY29udGV4dCBpcyBhbiBpZnJhbWUgb3VyIGpvYiBpcyBkb25lIG9uY2Ugd2UgZXhlY3V0ZSB0aGUgY2FsbGJhY2sgaGFuZGxlciBhcyBvdXIgc291cmNlIGlzIGxvYWRlZC4gVGhpc1xyXG4gICAgICAgICAgICAgICAgLy8gd2lsbCByZWxheSB0aGUgdG9rZW4gYmFjayB0byB0aGUgY2FsbGVyLlxyXG4gICAgICAgICAgICAgICAgaWYgKHRoaXMuaXNJbklGcmFtZSgpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgICAgICAgICB2YXIgdXNlciA9IHRoaXMuYXV0aENvbnRleHQuZ2V0Q2FjaGVkVXNlcigpO1xyXG4gICAgICAgICAgICAgICAgICAgIC8vIGdldCB0ZW5hbnQgZnJvbSBxdWVyeSBzdHJpbmcgcGFyYW1ldGVyIGFuZCBwYXNzIGl0IGluIGJlbG93XHJcbiAgICAgICAgICAgICAgICAgICAgdmFyIHRlbmFudCA9IHRoaXMuZ2V0VGVuYW50SWQod2luZG93LmxvY2F0aW9uLmhyZWYpO1xyXG4gICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLnNob3VsZExvZ0luSW52YWxpZFByb2ZpbGUodXNlciwgdGVuYW50KSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAvLyBzYXZlIHRoZSB1cmwgZm9yIHJlbG9hZCBvbmNlIHRoZSB1c2VyIGlzIGxvZ2dlZCBpblxyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnN0b3JlTG9jYXRpb25Gb3JOb25Mb2dnZWRJblVzZXIoKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy50cmFuc2ZlclVzZXIodHJ1ZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKHRoaXMuc2hvdWxkTG9nb3V0SW52YWxpZFByb2ZpbGUodXNlcikpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy50cmFuc2ZlclVzZXIoZmFsc2UpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zZW5kVGVsZW1ldHJ5KFwicG9zdGxvZ2luXCIpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmhhbmRsZVJlZGlyZWN0KHVzZXIpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGNhdGNoIChlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5zaG93RXJyb3IoZSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgIEF1dGhTdHJhcC5wcm90b3R5cGUuZ2V0UXVlcnlQYXJhbWV0ZXJCeU5hbWUgPSBmdW5jdGlvbiAobmFtZSwgdXJsKSB7XHJcbiAgICAgICAgICAgICAgICBpZiAoIXVybCkge1xyXG4gICAgICAgICAgICAgICAgICAgIHVybCA9IHdpbmRvdy5sb2NhdGlvbi5ocmVmO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgbmFtZSA9IG5hbWUucmVwbGFjZSgvW1xcW1xcXV0vZywgXCJcXFxcJCZcIik7XHJcbiAgICAgICAgICAgICAgICB2YXIgcmVnZXggPSBuZXcgUmVnRXhwKFwiWz8mXVwiICsgbmFtZSArIFwiKD0oW14mI10qKXwmfCN8JClcIiksIHJlc3VsdHMgPSByZWdleC5leGVjKHVybCk7XHJcbiAgICAgICAgICAgICAgICBpZiAoIXJlc3VsdHMpIHtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGlmICghcmVzdWx0c1syXSkge1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiAnJztcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIHJldHVybiBkZWNvZGVVUklDb21wb25lbnQocmVzdWx0c1syXS5yZXBsYWNlKC9cXCsvZywgXCIgXCIpKTtcclxuICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgQXV0aFN0cmFwLnByb3RvdHlwZS5nZXRUZW5hbnRJZCA9IGZ1bmN0aW9uICh1cmwpIHtcclxuICAgICAgICAgICAgICAgIGlmICh1cmwpIHtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5nZXRRdWVyeVBhcmFtZXRlckJ5TmFtZSgndGVuYW50SWQnLCB1cmwpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcclxuICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgcmV0dXJuIEF1dGhTdHJhcDtcclxuICAgICAgICB9KGF1dGguQXV0aFN0cmFwQmFzZSkpO1xyXG4gICAgICAgIGF1dGguQXV0aFN0cmFwID0gQXV0aFN0cmFwO1xyXG4gICAgfSkoYXV0aCA9IHRlYW1zcGFjZS5hdXRoIHx8ICh0ZWFtc3BhY2UuYXV0aCA9IHt9KSk7XHJcbn0pKHRlYW1zcGFjZSB8fCAodGVhbXNwYWNlID0ge30pKTtcclxuIl19
        var __extends = (this && this.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p]; };
        return extendStatics(d, b);
    }
    return function (d, b) {
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();
var teamspace;
(function (teamspace) {
    var auth;
    (function (auth) {
        /**
         * WARNING: If you update this file you need to keep in mind that this file is compiled and inserting into Authstrap.html.
         * Currently this file is served from local disc which is different from all other resources. Therefore be sure your change
         * is backwards compat with the FE bits.
         */
        var AuthStrapPPIUwp = /** @class */ (function (_super) {
            __extends(AuthStrapPPIUwp, _super);
            function AuthStrapPPIUwp(authContext, redirectUrl, $window, feCookieName, localStorage, sessionStorage, console, document, lastLocationHashName, showError, secureCookie, enableCookieStore, signInStateCookieName) {
                var _this = _super.call(this, authContext, redirectUrl, $window, feCookieName, localStorage, sessionStorage, console, document, lastLocationHashName, showError, secureCookie, enableCookieStore, signInStateCookieName) || this;
                _this.adalIdTokenKey = "adal.idtoken";
                _this.adalAccessTokenKey = "adal.access.token.key";
                _this.adalTokenExpirationKey = "adal.expiration.key";
                _this.adalTokenKeys = "adal.token.keys";
                _this.defaultNativeAuthTokenExpirationTimeUnderUwpPPI = 3600;
                return _this;
            }
            AuthStrapPPIUwp.prototype.isRunningInPPIUwpContainer = function () {
                var castedWindow = this.$window;
                var isRunningInPPIUwp = !!(castedWindow.Microsoft) &&
                    !!(castedWindow.Microsoft.PPISkype) &&
                    !!(castedWindow.Microsoft.PPISkype.Authentication) &&
                    !!(castedWindow.OAuthToken) &&
                    !!(castedWindow.OAuthToken.COAuthToken);
                if (isRunningInPPIUwp) {
                    var credentialsHandlerInstance = castedWindow.Microsoft.PPISkype.Authentication.CredentialsHandler.getInstance();
                    isRunningInPPIUwp = credentialsHandlerInstance.isRunningInPPIOs();
                }
                this.console.warn('Is Running in uwp ppi container?: ', isRunningInPPIUwp);
                return isRunningInPPIUwp;
            };
            AuthStrapPPIUwp.prototype.fetchTokenInPPIUwpContainer = function (audienceUri) {
                var castedWindow = this.$window;
                var credentialsHandler = castedWindow.Microsoft.PPISkype.Authentication.CredentialsHandler.getInstance();
                var userCredential = credentialsHandler.getPlaintextAllCredentials();
                if (userCredential == null) {
                    return null;
                }
                var oauthTokenFetcher = castedWindow.OAuthToken.COAuthToken.getOrCreateInstance();
                var oauthToken = oauthTokenFetcher.acquireToken(userCredential.signInAddress, userCredential.password, '', '', '', audienceUri);
                return oauthToken;
            };
            AuthStrapPPIUwp.prototype.cacheAdalOAuthTokenInIdTokenCacheUnderPPIUwp = function (token) {
                if (token == null) {
                    return;
                }
                if (this.localStorage) {
                    try {
                        this.localStorage.setItem(this.adalIdTokenKey, token);
                    }
                    catch (e) {
                        this.showError('Failed to set item in local storage ' + e);
                    }
                }
                var user = this.authContext.getCachedUser();
                var invalidUser = !user || !user.profile || !user.profile.aud || !user.profile.exp;
                if (!invalidUser) {
                    this.cacheTokenInAccessCacheUnderPPIUwp(token, user.profile.aud, user.profile.exp);
                }
            };
            AuthStrapPPIUwp.prototype.cacheTokenInAccessCacheUnderPPIUwp = function (token, additionalKey, exp) {
                if (token == null) {
                    return;
                }
                if (this.localStorage) {
                    try {
                        exp = exp ? exp : Math.round(new Date().getTime() / 1000.0) + this.defaultNativeAuthTokenExpirationTimeUnderUwpPPI;
                        this.localStorage.setItem(this.adalAccessTokenKey + additionalKey, token);
                        this.localStorage.setItem(this.adalTokenExpirationKey + additionalKey, exp);
                        var keys = this.localStorage.getItem(this.adalTokenKeys) || '';
                        if (keys.indexOf(additionalKey) < 0) {
                            this.localStorage.setItem(this.adalTokenKeys, keys + additionalKey + '|');
                        }
                    }
                    catch (e) {
                        this.showError('Failed requests to local storage ' + e);
                    }
                }
            };
            AuthStrapPPIUwp.prototype.tryFetchAndCacheIdTokenInPPIUwpContainer = function () {
                if (this.isRunningInPPIUwpContainer()) {
                    var token = this.fetchTokenInPPIUwpContainer(this.authContext.config.clientId);
                    this.cacheAdalOAuthTokenInIdTokenCacheUnderPPIUwp(token);
                }
            };
            /**
             * Handles the login flow with adal both user redirect as well as iframe refresh.
             *
             * If not an iframe the user is logging in initially or by return to the site.
             *    If the user is not logged in(or profile expired), login via adal is executed which redirects to the site once complete.
             *    Else redirects to the site.
             * If in an iframe this is a token refresh, tell adal the window is loaded via callback. That is all that is needed. **DO NOT REDIRECT TO SITE**
             */
            AuthStrapPPIUwp.prototype.handleWindow = function () {
                // Check for AAD error in URL
                if (window.location.hash.indexOf("AADSTS50000") >= 0) {
                    window.location.assign(this.redirectUrl + 'error/incompatible_compliance_policy');
                    return;
                }
                // If the context is an iframe our job is done once we execute the callback handler as our source is loaded. This
                // will relay the token back to the caller.
                if (this.isInIFrame()) {
                    return;
                }
                try {
                    this.tryFetchAndCacheIdTokenInPPIUwpContainer();
                    this.sendTelemetry("postloginppiuwp");
                    var user = this.authContext.getCachedUser();
                    this.handleRedirect(user);
                }
                catch (e) {
                    this.showError(e);
                }
            };
            return AuthStrapPPIUwp;
        }(auth.AuthStrapBase));
        auth.AuthStrapPPIUwp = AuthStrapPPIUwp;
    })(auth = teamspace.auth || (teamspace.auth = {}));
})(teamspace || (teamspace = {}));

//# sourceMappingURL=data:application/json;base64,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LGNBQWMsWUFBWTs0Q0FDZSIsInNvdXJjZXNDb250ZW50IjpbInZhciBfX2V4dGVuZHMgPSAodGhpcyAmJiB0aGlzLl9fZXh0ZW5kcykgfHwgKGZ1bmN0aW9uICgpIHtcclxuICAgIHZhciBleHRlbmRTdGF0aWNzID0gZnVuY3Rpb24gKGQsIGIpIHtcclxuICAgICAgICBleHRlbmRTdGF0aWNzID0gT2JqZWN0LnNldFByb3RvdHlwZU9mIHx8XHJcbiAgICAgICAgICAgICh7IF9fcHJvdG9fXzogW10gfSBpbnN0YW5jZW9mIEFycmF5ICYmIGZ1bmN0aW9uIChkLCBiKSB7IGQuX19wcm90b19fID0gYjsgfSkgfHxcclxuICAgICAgICAgICAgZnVuY3Rpb24gKGQsIGIpIHsgZm9yICh2YXIgcCBpbiBiKSBpZiAoYi5oYXNPd25Qcm9wZXJ0eShwKSkgZFtwXSA9IGJbcF07IH07XHJcbiAgICAgICAgcmV0dXJuIGV4dGVuZFN0YXRpY3MoZCwgYik7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gZnVuY3Rpb24gKGQsIGIpIHtcclxuICAgICAgICBleHRlbmRTdGF0aWNzKGQsIGIpO1xyXG4gICAgICAgIGZ1bmN0aW9uIF9fKCkgeyB0aGlzLmNvbnN0cnVjdG9yID0gZDsgfVxyXG4gICAgICAgIGQucHJvdG90eXBlID0gYiA9PT0gbnVsbCA/IE9iamVjdC5jcmVhdGUoYikgOiAoX18ucHJvdG90eXBlID0gYi5wcm90b3R5cGUsIG5ldyBfXygpKTtcclxuICAgIH07XHJcbn0pKCk7XHJcbnZhciB0ZWFtc3BhY2U7XHJcbihmdW5jdGlvbiAodGVhbXNwYWNlKSB7XHJcbiAgICB2YXIgYXV0aDtcclxuICAgIChmdW5jdGlvbiAoYXV0aCkge1xyXG4gICAgICAgIC8qKlxyXG4gICAgICAgICAqIFdBUk5JTkc6IElmIHlvdSB1cGRhdGUgdGhpcyBmaWxlIHlvdSBuZWVkIHRvIGtlZXAgaW4gbWluZCB0aGF0IHRoaXMgZmlsZSBpcyBjb21waWxlZCBhbmQgaW5zZXJ0aW5nIGludG8gQXV0aHN0cmFwLmh0bWwuXHJcbiAgICAgICAgICogQ3VycmVudGx5IHRoaXMgZmlsZSBpcyBzZXJ2ZWQgZnJvbSBsb2NhbCBkaXNjIHdoaWNoIGlzIGRpZmZlcmVudCBmcm9tIGFsbCBvdGhlciByZXNvdXJjZXMuIFRoZXJlZm9yZSBiZSBzdXJlIHlvdXIgY2hhbmdlXHJcbiAgICAgICAgICogaXMgYmFja3dhcmRzIGNvbXBhdCB3aXRoIHRoZSBGRSBiaXRzLlxyXG4gICAgICAgICAqL1xyXG4gICAgICAgIHZhciBBdXRoU3RyYXBQUElVd3AgPSAvKiogQGNsYXNzICovIChmdW5jdGlvbiAoX3N1cGVyKSB7XHJcbiAgICAgICAgICAgIF9fZXh0ZW5kcyhBdXRoU3RyYXBQUElVd3AsIF9zdXBlcik7XHJcbiAgICAgICAgICAgIGZ1bmN0aW9uIEF1dGhTdHJhcFBQSVV3cChhdXRoQ29udGV4dCwgcmVkaXJlY3RVcmwsICR3aW5kb3csIGZlQ29va2llTmFtZSwgbG9jYWxTdG9yYWdlLCBzZXNzaW9uU3RvcmFnZSwgY29uc29sZSwgZG9jdW1lbnQsIGxhc3RMb2NhdGlvbkhhc2hOYW1lLCBzaG93RXJyb3IsIHNlY3VyZUNvb2tpZSwgZW5hYmxlQ29va2llU3RvcmUsIHNpZ25JblN0YXRlQ29va2llTmFtZSkge1xyXG4gICAgICAgICAgICAgICAgdmFyIF90aGlzID0gX3N1cGVyLmNhbGwodGhpcywgYXV0aENvbnRleHQsIHJlZGlyZWN0VXJsLCAkd2luZG93LCBmZUNvb2tpZU5hbWUsIGxvY2FsU3RvcmFnZSwgc2Vzc2lvblN0b3JhZ2UsIGNvbnNvbGUsIGRvY3VtZW50LCBsYXN0TG9jYXRpb25IYXNoTmFtZSwgc2hvd0Vycm9yLCBzZWN1cmVDb29raWUsIGVuYWJsZUNvb2tpZVN0b3JlLCBzaWduSW5TdGF0ZUNvb2tpZU5hbWUpIHx8IHRoaXM7XHJcbiAgICAgICAgICAgICAgICBfdGhpcy5hZGFsSWRUb2tlbktleSA9IFwiYWRhbC5pZHRva2VuXCI7XHJcbiAgICAgICAgICAgICAgICBfdGhpcy5hZGFsQWNjZXNzVG9rZW5LZXkgPSBcImFkYWwuYWNjZXNzLnRva2VuLmtleVwiO1xyXG4gICAgICAgICAgICAgICAgX3RoaXMuYWRhbFRva2VuRXhwaXJhdGlvbktleSA9IFwiYWRhbC5leHBpcmF0aW9uLmtleVwiO1xyXG4gICAgICAgICAgICAgICAgX3RoaXMuYWRhbFRva2VuS2V5cyA9IFwiYWRhbC50b2tlbi5rZXlzXCI7XHJcbiAgICAgICAgICAgICAgICBfdGhpcy5kZWZhdWx0TmF0aXZlQXV0aFRva2VuRXhwaXJhdGlvblRpbWVVbmRlclV3cFBQSSA9IDM2MDA7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gX3RoaXM7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgQXV0aFN0cmFwUFBJVXdwLnByb3RvdHlwZS5pc1J1bm5pbmdJblBQSVV3cENvbnRhaW5lciA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgICAgIHZhciBjYXN0ZWRXaW5kb3cgPSB0aGlzLiR3aW5kb3c7XHJcbiAgICAgICAgICAgICAgICB2YXIgaXNSdW5uaW5nSW5QUElVd3AgPSAhIShjYXN0ZWRXaW5kb3cuTWljcm9zb2Z0KSAmJlxyXG4gICAgICAgICAgICAgICAgICAgICEhKGNhc3RlZFdpbmRvdy5NaWNyb3NvZnQuUFBJU2t5cGUpICYmXHJcbiAgICAgICAgICAgICAgICAgICAgISEoY2FzdGVkV2luZG93Lk1pY3Jvc29mdC5QUElTa3lwZS5BdXRoZW50aWNhdGlvbikgJiZcclxuICAgICAgICAgICAgICAgICAgICAhIShjYXN0ZWRXaW5kb3cuT0F1dGhUb2tlbikgJiZcclxuICAgICAgICAgICAgICAgICAgICAhIShjYXN0ZWRXaW5kb3cuT0F1dGhUb2tlbi5DT0F1dGhUb2tlbik7XHJcbiAgICAgICAgICAgICAgICBpZiAoaXNSdW5uaW5nSW5QUElVd3ApIHtcclxuICAgICAgICAgICAgICAgICAgICB2YXIgY3JlZGVudGlhbHNIYW5kbGVySW5zdGFuY2UgPSBjYXN0ZWRXaW5kb3cuTWljcm9zb2Z0LlBQSVNreXBlLkF1dGhlbnRpY2F0aW9uLkNyZWRlbnRpYWxzSGFuZGxlci5nZXRJbnN0YW5jZSgpO1xyXG4gICAgICAgICAgICAgICAgICAgIGlzUnVubmluZ0luUFBJVXdwID0gY3JlZGVudGlhbHNIYW5kbGVySW5zdGFuY2UuaXNSdW5uaW5nSW5QUElPcygpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgdGhpcy5jb25zb2xlLndhcm4oJ0lzIFJ1bm5pbmcgaW4gdXdwIHBwaSBjb250YWluZXI/OiAnLCBpc1J1bm5pbmdJblBQSVV3cCk7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gaXNSdW5uaW5nSW5QUElVd3A7XHJcbiAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgIEF1dGhTdHJhcFBQSVV3cC5wcm90b3R5cGUuZmV0Y2hUb2tlbkluUFBJVXdwQ29udGFpbmVyID0gZnVuY3Rpb24gKGF1ZGllbmNlVXJpKSB7XHJcbiAgICAgICAgICAgICAgICB2YXIgY2FzdGVkV2luZG93ID0gdGhpcy4kd2luZG93O1xyXG4gICAgICAgICAgICAgICAgdmFyIGNyZWRlbnRpYWxzSGFuZGxlciA9IGNhc3RlZFdpbmRvdy5NaWNyb3NvZnQuUFBJU2t5cGUuQXV0aGVudGljYXRpb24uQ3JlZGVudGlhbHNIYW5kbGVyLmdldEluc3RhbmNlKCk7XHJcbiAgICAgICAgICAgICAgICB2YXIgdXNlckNyZWRlbnRpYWwgPSBjcmVkZW50aWFsc0hhbmRsZXIuZ2V0UGxhaW50ZXh0QWxsQ3JlZGVudGlhbHMoKTtcclxuICAgICAgICAgICAgICAgIGlmICh1c2VyQ3JlZGVudGlhbCA9PSBudWxsKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB2YXIgb2F1dGhUb2tlbkZldGNoZXIgPSBjYXN0ZWRXaW5kb3cuT0F1dGhUb2tlbi5DT0F1dGhUb2tlbi5nZXRPckNyZWF0ZUluc3RhbmNlKCk7XHJcbiAgICAgICAgICAgICAgICB2YXIgb2F1dGhUb2tlbiA9IG9hdXRoVG9rZW5GZXRjaGVyLmFjcXVpcmVUb2tlbih1c2VyQ3JlZGVudGlhbC5zaWduSW5BZGRyZXNzLCB1c2VyQ3JlZGVudGlhbC5wYXNzd29yZCwgJycsICcnLCAnJywgYXVkaWVuY2VVcmkpO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIG9hdXRoVG9rZW47XHJcbiAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgIEF1dGhTdHJhcFBQSVV3cC5wcm90b3R5cGUuY2FjaGVBZGFsT0F1dGhUb2tlbkluSWRUb2tlbkNhY2hlVW5kZXJQUElVd3AgPSBmdW5jdGlvbiAodG9rZW4pIHtcclxuICAgICAgICAgICAgICAgIGlmICh0b2tlbiA9PSBudWxsKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgaWYgKHRoaXMubG9jYWxTdG9yYWdlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5sb2NhbFN0b3JhZ2Uuc2V0SXRlbSh0aGlzLmFkYWxJZFRva2VuS2V5LCB0b2tlbik7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIGNhdGNoIChlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc2hvd0Vycm9yKCdGYWlsZWQgdG8gc2V0IGl0ZW0gaW4gbG9jYWwgc3RvcmFnZSAnICsgZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgdmFyIHVzZXIgPSB0aGlzLmF1dGhDb250ZXh0LmdldENhY2hlZFVzZXIoKTtcclxuICAgICAgICAgICAgICAgIHZhciBpbnZhbGlkVXNlciA9ICF1c2VyIHx8ICF1c2VyLnByb2ZpbGUgfHwgIXVzZXIucHJvZmlsZS5hdWQgfHwgIXVzZXIucHJvZmlsZS5leHA7XHJcbiAgICAgICAgICAgICAgICBpZiAoIWludmFsaWRVc2VyKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5jYWNoZVRva2VuSW5BY2Nlc3NDYWNoZVVuZGVyUFBJVXdwKHRva2VuLCB1c2VyLnByb2ZpbGUuYXVkLCB1c2VyLnByb2ZpbGUuZXhwKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgQXV0aFN0cmFwUFBJVXdwLnByb3RvdHlwZS5jYWNoZVRva2VuSW5BY2Nlc3NDYWNoZVVuZGVyUFBJVXdwID0gZnVuY3Rpb24gKHRva2VuLCBhZGRpdGlvbmFsS2V5LCBleHApIHtcclxuICAgICAgICAgICAgICAgIGlmICh0b2tlbiA9PSBudWxsKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgaWYgKHRoaXMubG9jYWxTdG9yYWdlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgZXhwID0gZXhwID8gZXhwIDogTWF0aC5yb3VuZChuZXcgRGF0ZSgpLmdldFRpbWUoKSAvIDEwMDAuMCkgKyB0aGlzLmRlZmF1bHROYXRpdmVBdXRoVG9rZW5FeHBpcmF0aW9uVGltZVVuZGVyVXdwUFBJO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmxvY2FsU3RvcmFnZS5zZXRJdGVtKHRoaXMuYWRhbEFjY2Vzc1Rva2VuS2V5ICsgYWRkaXRpb25hbEtleSwgdG9rZW4pO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmxvY2FsU3RvcmFnZS5zZXRJdGVtKHRoaXMuYWRhbFRva2VuRXhwaXJhdGlvbktleSArIGFkZGl0aW9uYWxLZXksIGV4cCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBrZXlzID0gdGhpcy5sb2NhbFN0b3JhZ2UuZ2V0SXRlbSh0aGlzLmFkYWxUb2tlbktleXMpIHx8ICcnO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoa2V5cy5pbmRleE9mKGFkZGl0aW9uYWxLZXkpIDwgMCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5sb2NhbFN0b3JhZ2Uuc2V0SXRlbSh0aGlzLmFkYWxUb2tlbktleXMsIGtleXMgKyBhZGRpdGlvbmFsS2V5ICsgJ3wnKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICBjYXRjaCAoZSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnNob3dFcnJvcignRmFpbGVkIHJlcXVlc3RzIHRvIGxvY2FsIHN0b3JhZ2UgJyArIGUpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgQXV0aFN0cmFwUFBJVXdwLnByb3RvdHlwZS50cnlGZXRjaEFuZENhY2hlSWRUb2tlbkluUFBJVXdwQ29udGFpbmVyID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICAgICAgaWYgKHRoaXMuaXNSdW5uaW5nSW5QUElVd3BDb250YWluZXIoKSkge1xyXG4gICAgICAgICAgICAgICAgICAgIHZhciB0b2tlbiA9IHRoaXMuZmV0Y2hUb2tlbkluUFBJVXdwQ29udGFpbmVyKHRoaXMuYXV0aENvbnRleHQuY29uZmlnLmNsaWVudElkKTtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLmNhY2hlQWRhbE9BdXRoVG9rZW5JbklkVG9rZW5DYWNoZVVuZGVyUFBJVXdwKHRva2VuKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgLyoqXHJcbiAgICAgICAgICAgICAqIEhhbmRsZXMgdGhlIGxvZ2luIGZsb3cgd2l0aCBhZGFsIGJvdGggdXNlciByZWRpcmVjdCBhcyB3ZWxsIGFzIGlmcmFtZSByZWZyZXNoLlxyXG4gICAgICAgICAgICAgKlxyXG4gICAgICAgICAgICAgKiBJZiBub3QgYW4gaWZyYW1lIHRoZSB1c2VyIGlzIGxvZ2dpbmcgaW4gaW5pdGlhbGx5IG9yIGJ5IHJldHVybiB0byB0aGUgc2l0ZS5cclxuICAgICAgICAgICAgICogICAgSWYgdGhlIHVzZXIgaXMgbm90IGxvZ2dlZCBpbihvciBwcm9maWxlIGV4cGlyZWQpLCBsb2dpbiB2aWEgYWRhbCBpcyBleGVjdXRlZCB3aGljaCByZWRpcmVjdHMgdG8gdGhlIHNpdGUgb25jZSBjb21wbGV0ZS5cclxuICAgICAgICAgICAgICogICAgRWxzZSByZWRpcmVjdHMgdG8gdGhlIHNpdGUuXHJcbiAgICAgICAgICAgICAqIElmIGluIGFuIGlmcmFtZSB0aGlzIGlzIGEgdG9rZW4gcmVmcmVzaCwgdGVsbCBhZGFsIHRoZSB3aW5kb3cgaXMgbG9hZGVkIHZpYSBjYWxsYmFjay4gVGhhdCBpcyBhbGwgdGhhdCBpcyBuZWVkZWQuICoqRE8gTk9UIFJFRElSRUNUIFRPIFNJVEUqKlxyXG4gICAgICAgICAgICAgKi9cclxuICAgICAgICAgICAgQXV0aFN0cmFwUFBJVXdwLnByb3RvdHlwZS5oYW5kbGVXaW5kb3cgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgICAgICAvLyBDaGVjayBmb3IgQUFEIGVycm9yIGluIFVSTFxyXG4gICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5sb2NhdGlvbi5oYXNoLmluZGV4T2YoXCJBQURTVFM1MDAwMFwiKSA+PSAwKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgd2luZG93LmxvY2F0aW9uLmFzc2lnbih0aGlzLnJlZGlyZWN0VXJsICsgJ2Vycm9yL2luY29tcGF0aWJsZV9jb21wbGlhbmNlX3BvbGljeScpO1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIC8vIElmIHRoZSBjb250ZXh0IGlzIGFuIGlmcmFtZSBvdXIgam9iIGlzIGRvbmUgb25jZSB3ZSBleGVjdXRlIHRoZSBjYWxsYmFjayBoYW5kbGVyIGFzIG91ciBzb3VyY2UgaXMgbG9hZGVkLiBUaGlzXHJcbiAgICAgICAgICAgICAgICAvLyB3aWxsIHJlbGF5IHRoZSB0b2tlbiBiYWNrIHRvIHRoZSBjYWxsZXIuXHJcbiAgICAgICAgICAgICAgICBpZiAodGhpcy5pc0luSUZyYW1lKCkpIHtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMudHJ5RmV0Y2hBbmRDYWNoZUlkVG9rZW5JblBQSVV3cENvbnRhaW5lcigpO1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuc2VuZFRlbGVtZXRyeShcInBvc3Rsb2dpbnBwaXV3cFwiKTtcclxuICAgICAgICAgICAgICAgICAgICB2YXIgdXNlciA9IHRoaXMuYXV0aENvbnRleHQuZ2V0Q2FjaGVkVXNlcigpO1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuaGFuZGxlUmVkaXJlY3QodXNlcik7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBjYXRjaCAoZSkge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuc2hvd0Vycm9yKGUpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICByZXR1cm4gQXV0aFN0cmFwUFBJVXdwO1xyXG4gICAgICAgIH0oYXV0aC5BdXRoU3RyYXBCYXNlKSk7XHJcbiAgICAgICAgYXV0aC5BdXRoU3RyYXBQUElVd3AgPSBBdXRoU3RyYXBQUElVd3A7XHJcbiAgICB9KShhdXRoID0gdGVhbXNwYWNlLmF1dGggfHwgKHRlYW1zcGFjZS5hdXRoID0ge30pKTtcclxufSkodGVhbXNwYWNlIHx8ICh0ZWFtc3BhY2UgPSB7fSkpO1xyXG4iXX0=

        var globalResource = true ?
            undefined :
            'https://api.spaces.skype.com';

        var rootUri = 'https://teams.microsoft.com/'; // rootUri will be replaced by the web server (IndexController.Auth).
        if (rootUri.charAt(0) === '[')
        {
          // TODO (chschafl): Remove fallback once authConstants.redirectUri has been removed.
          rootUri = '{SETINENVIRONMENTTRANSFORM}';
          if (rootUri.charAt(rootUri.length - 1) !== '/')
          {
            rootUri += '/';
          }
        }

        var clientId = '5e3ce6c0-2b1f-4285-8d4b-75ee78787346'; // clientId will be replaced by the web server (IndexController.Auth)
        if (clientId.charAt(0) === '[')
        {
          // Fallback to default client Id if the webserver doesn't replace it.
          clientId = '5e3ce6c0-2b1f-4285-8d4b-75ee78787346';
        }

        var redirectRoute = 'go';
        var redirectUri = rootUri + redirectRoute;

        // correlationId will be replaced by the web server (IndexController.Auth)
        var correlationId = '578b0d3e-13cb-4c53-9eb1-3108e75905bf';
        if (correlationId.charAt(0) === '[')
        {
          // Fallback to default correlationId Id if the webserver doesn't replace it.
          correlationId = undefined;
        }

        window.config = {
          // Read values from config instead of hardcoding
          redirectUri: redirectUri,
          postLogoutRedirectUri: redirectUri,
          instance: 'https://login.microsoftonline.com/',
          clientId: clientId,
          correlationId: correlationId,
          globalResource: globalResource,
          cacheLocation: 'localStorage',
          extraQueryParameter: '',
          enableErrorPageRedirect: '',
          enableGuestAccess: true
          };

        var redirectToErrorPage = function () {
          window.location.assign(rootUri + 'error/DOM_storage_disabled');
        };

        var showError = function (e) {
          console.error('Error occurred logging in ' + JSON.stringify(e));
          if (window.electronSafeIpc) {
            window.electronSafeIpc.send('pageContentError');
          }
          redirectToErrorPage();
        };

        var localStorageEnabled = function() {
          var value = 'skypeStorageTest';
          try {
            localStorage.setItem(value, value);
            localStorage.removeItem(value);
            return true;
          } catch(e) {
            showError(e);
            return false;
          }
        };

        if(!localStorageEnabled()) {
          // Redirect to DOM error page
          redirectToErrorPage();
          return;
        }

        var authContext = new AuthenticationContext(config);
        var authStrap;
        var isRunningInSurfaceHubUniversalContainer = window.Microsoft &&
                                                      window.Microsoft.PPISkype &&
                                                      window.Microsoft.PPISkype.Authentication &&
                                                      window.Microsoft.PPISkype.Authentication.CredentialsHandler &&
                                                      window.Microsoft.PPISkype.Authentication.CredentialsHandler.getInstance().isRunningInPPIOs();

        if (isRunningInSurfaceHubUniversalContainer) {
          authStrap = new teamspace.auth.AuthStrapPPIUwp(authContext,
                rootUri,
                window,
                'TSAUTHCOOKIE',
                localStorage,
                sessionStorage,
                console,
                document,
                'lastLocationHash',
                showError,
                true,
                true,
                'TSPREAUTHCOOKIE');

        } else {
          authStrap = new teamspace.auth.AuthStrap(authContext,
                rootUri,
                window,
                'TSAUTHCOOKIE',
                localStorage,
                sessionStorage,
                console,
                document,
                'lastLocationHash',
                redirectRoute,
                showError,
                true,
                true,
                'TSPREAUTHCOOKIE',
                true);
        }

        authStrap.handleWindow();

        sendAppStateChanged('AuthstrapJsLoaded');
      });
    })();
  </script>
</head>
<body>
<style>
  body {
    margin: 0;
  }
  #errorContent {
    display: none;
    padding-top: 32px;
  }
  #errorContent header {
    background-color:#293955;
    color:#fff;
    text-align:center;
    padding:5px;
  }
  #helpContent,
  #errorContent header{
    margin-bottom: 10px;
  }
</style>
<div id="errorContent">
  <header>
    <h1>Oops...</h1>
  </header>
  <div id="helpContent">
    <h3>Looks like we were unable to authenticate.</h3>
    <div>Please verify you are using a supported browser with local storage enabled. </div>
    <div>If viewing in private/incognito mode please try opening a standard tab.</div>
  </div>
  <details>
    <div>Code:&nbsp;<span id="errorCode"></span></div>
    <div>Error:&nbsp;<span id="errorName"></span></div>
  </details>
</div>
<script nonce="">
  sendAppStateChanged('AuthstrapHtmlLoaded');
</script>


</body></html>