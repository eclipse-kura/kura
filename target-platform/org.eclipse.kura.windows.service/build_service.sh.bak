#!/bin/bash
#
# This script is used to build the KURAService executables used to run KURA as a service on Windows based systems. It relies on
# mingw64 to do the build. If mingw64 is not installed it skips the build without error so that the pre built binary will be used
#
# It's called with one of two arguments 'clean' in which case the object files are deleted, or 'build' in which case the files are
# rebuilt. Take care here to make sure that the required build tools are installed, mingw32-make then i686-w64-mingw32-gcc for the
# 32 bit version and x86_64-w64-mingw32-gcc for the 64 bit version. These should all be installed with the mingw64 package.

if [ "$1" == "clean" ]; then
	if [ -x "$(command -v mingw32-make)" ]; then

		if [ -x "$(command -v i686-w64-mingw32-gcc)" ]; then
			for f in KURAService/Objs/*32*; do
				if [ -f "$f" ];then
					echo Deleting $f
					rm $f
				fi
			done
		fi

		if [ -x "$(command -v x86_64-w64-mingw32-gcc)" ]; then
			for f in KURAService/Objs/*64*; do
				if [ -f "$f" ]; then
					echo Deleting $f
					rm $f
				fi
			done
		fi

	fi
fi

if [ "$1" == "build" ]; then

	if [ -x "$(command -v mingw32-make)" ]; then
		cd KURAService
		if [ -x "$(command -v i686-w64-mingw32-gcc)" ]; then
			mingw32-make KURAService32
		fi

		if [ -x "$(command -v x86_64-w64-mingw32-gcc)" ]; then
			mingw32-make KURAService64
		fi
	fi
fi
